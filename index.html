<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Eu te amo Ana Clara ‚ù§ ‚Äì Spotify</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin:0;
      padding:20px;
      background:#0f172a;
      color:#e5e7eb;
    }
    .card{
      max-width:600px;
      margin:0 auto;
      background:#020617;
      border-radius:16px;
      padding:18px 16px 20px;
      box-shadow:0 20px 40px rgba(0,0,0,0.6);
      border:1px solid rgba(148,163,184,0.35);
    }
    h1{
      margin:0 0 4px;
      font-size:22px;
    }
    .sub{
      margin:0 0 14px;
      font-size:13px;
      color:#9ca3af;
    }
    .row{
      margin-top:10px;
    }
    button{
      border:0;
      border-radius:999px;
      padding:8px 14px;
      font-weight:600;
      cursor:pointer;
      font-size:14px;
    }
    .btn-login{
      background:#22c55e;
      color:#022c22;
    }
    .btn-play{
      background:#0ea5e9;
      color:#0b1120;
    }
    .status{
      font-size:13px;
      margin-top:10px;
      color:#a5b4fc;
    }
    .log{
      margin-top:14px;
      font-size:11px;
      background:#020617;
      border-radius:10px;
      border:1px solid rgba(75,85,99,0.7);
      padding:8px 10px;
      max-height:180px;
      overflow:auto;
      white-space:pre-wrap;
    }
    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:#22c55e33;
      color:#4ade80;
      font-size:11px;
      margin-bottom:4px;
    }
    a{
      color:#38bdf8;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Spotify Web Playback ‚Äì Pablo & Ana üíï</h1>
    <p class="sub">
      Aqui voc√™s testam o login com Spotify Premium e tocar a playlist inteira direto no navegador.
      <br><strong>Importante:</strong> o redirect precisa estar cadastrado exatamente assim no painel do Spotify Developer:
      <br><code>https://euteamoanaclara.top/</code> <em>ou</em> <code>https://euteamoanaclara.top/index.html</code>, de acordo com o endere√ßo que voc√™s usarem.
    </p>

    <div class="row">
      <button id="spotifyLoginBtn" class="btn-login">Entrar com Spotify</button>
      <button id="spotifyPlayBtn" class="btn-play">Tocar playlist aqui</button>
    </div>

    <div class="status" id="spotifyStatus">Ainda n√£o conectado ao Spotify.</div>

    <div class="log" id="spotifyLog">
      <span class="badge">LOG</span> Aqui v√£o aparecer mensagens t√©cnicas pra voc√™s verem se deu certo.
    </div>
  </div>

  <!-- SDK oficial do Spotify -->
  <script src="https://sdk.scdn.co/spotify-player.js"></script>

  <script>
    // ==============================
    // CONFIGURA√á√ïES B√ÅSICAS
    // ==============================
    const spotifyClientId   = "d87db58ea9434615bb2c2603e7ff4326";
    const spotifyRedirectUri = window.location.origin + window.location.pathname; 
    // Ex.: https://euteamoanaclara.top/  ou  https://euteamoanaclara.top/index.html
    // Lembra de cadastar EXATAMENTE isso no painel do Spotify Developer

    const spotifyPlaylistUri = "spotify:playlist:3RitDlOniO6hRIQxmLWrMw";

    let spotifyAccessToken = null;
    let spotifyTokenExpiresAt = null;
    let spotifyPlayer = null;
    let spotifyDeviceId = null;

    const logBox = document.getElementById("spotifyLog");
    const statusEl = document.getElementById("spotifyStatus");
    function log(msg){
      console.log("[Spotify]", msg);
      if(!logBox) return;
      const now = new Date();
      const prefix = "[" + now.toLocaleTimeString("pt-BR") + "] ";
      logBox.textContent += "\n" + prefix + msg;
      logBox.scrollTop = logBox.scrollHeight;
    }
    function setStatus(msg){
      if(statusEl) statusEl.textContent = msg;
    }

    // ==============================
    // ARMAZENAMENTO DO TOKEN
    // ==============================
    function loadStoredSpotifyToken(){
      try{
        const raw = localStorage.getItem("spotifyAuth");
        if(!raw) return null;
        const data = JSON.parse(raw);
        if(!data.access_token) return null;
        if(data.expires_at && Date.now() > data.expires_at){
          log("Token Spotify expirado.");
          return null;
        }
        return data;
      }catch(e){
        log("Erro ao ler token armazenado: " + e);
        return null;
      }
    }

    function saveSpotifyToken(data){
      if(!data) return;
      const expiresAt = Date.now() + (data.expires_in ? (data.expires_in * 1000) : 3600*1000);
      const payload = {
        access_token: data.access_token,
        refresh_token: data.refresh_token || null,
        expires_at: expiresAt
      };
      localStorage.setItem("spotifyAuth", JSON.stringify(payload));
      spotifyAccessToken = payload.access_token;
      spotifyTokenExpiresAt = payload.expires_at;
      setStatus("Conectado ao Spotify üíö");
      log("Token Spotify salvo com sucesso.");
    }

    function getSpotifyAccessToken(){
      if(spotifyAccessToken && spotifyTokenExpiresAt && Date.now() < spotifyTokenExpiresAt){
        return spotifyAccessToken;
      }
      const stored = loadStoredSpotifyToken();
      if(stored){
        spotifyAccessToken = stored.access_token;
        spotifyTokenExpiresAt = stored.expires_at;
        setStatus("Conectado ao Spotify üíö");
        return spotifyAccessToken;
      }
      return null;
    }

    // ==============================
    // PKCE (c√≥digo + desafio)
    // ==============================
    async function generateCodeVerifier(){
      const array = new Uint8Array(64);
      crypto.getRandomValues(array);
      let str = "";
      for(const v of array){
        str += String.fromCharCode(v % 26 + 97); // s√≥ letras a-z
      }
      return str;
    }

    async function sha256(text){
      const encoder = new TextEncoder();
      const data = encoder.encode(text);
      const digest = await crypto.subtle.digest("SHA-256", data);
      return new Uint8Array(digest);
    }

    function base64UrlEncode(bytes){
      let str = "";
      for(const b of bytes){
        str += String.fromCharCode(b);
      }
      return btoa(str).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
    }

    async function startSpotifyLogin(){
      try{
        const verifier = await generateCodeVerifier();
        const challengeBytes = await sha256(verifier);
        const challenge = base64UrlEncode(challengeBytes);
        const state = Math.random().toString(36).substring(2);
        localStorage.setItem("spotify_code_verifier", verifier);
        localStorage.setItem("spotify_auth_state", state);

        const params = new URLSearchParams({
          client_id: spotifyClientId,
          response_type: "code",
          redirect_uri: spotifyRedirectUri,
          code_challenge_method: "S256",
          code_challenge: challenge,
          state: state,
          scope: "user-modify-playback-state user-read-playback-state streaming user-read-email user-read-private"
        });

        const url = "https://accounts.spotify.com/authorize?" + params.toString();
        log("Redirecionando para login do Spotify...");
        window.location.href = url;
      }catch(e){
        console.error(e);
        alert("N√£o consegui iniciar o login com o Spotify üò¢");
        log("Erro ao iniciar login Spotify: " + e);
      }
    }

    async function handleSpotifyCallbackIfNeeded(){
      const url = new URL(window.location.href);
      const code = url.searchParams.get("code");
      const state = url.searchParams.get("state");
      const error = url.searchParams.get("error");
      if(error){
        log("Spotify retornou erro: " + error);
        setStatus("Erro vindo do Spotify: " + error);
      }
      if(!code){
        const stored = loadStoredSpotifyToken();
        if(stored){
          spotifyAccessToken = stored.access_token;
          spotifyTokenExpiresAt = stored.expires_at;
          setStatus("Conectado ao Spotify üíö");
        }else{
          setStatus("Ainda n√£o conectado ao Spotify.");
        }
        return;
      }
      try{
        const savedState = localStorage.getItem("spotify_auth_state");
        const verifier = localStorage.getItem("spotify_code_verifier");
        localStorage.removeItem("spotify_auth_state");
        localStorage.removeItem("spotify_code_verifier");
        if(!verifier || (savedState && state && savedState !== state)){
          log("State/verifier inv√°lidos. Abortando.");
          setStatus("Problema ao conectar ao Spotify üò¢");
          return;
        }

        const body = new URLSearchParams({
          client_id: spotifyClientId,
          grant_type: "authorization_code",
          code: code,
          redirect_uri: spotifyRedirectUri,
          code_verifier: verifier
        });

        log("Trocando c√≥digo por token...");
        const resp = await fetch("https://accounts.spotify.com/api/token", {
          method: "POST",
          headers: {"Content-Type": "application/x-www-form-urlencoded"},
          body
        });
        if(!resp.ok){
          const txt = await resp.text();
          log("Falha ao buscar token: " + txt);
          setStatus("N√£o consegui finalizar o login do Spotify üò¢");
          return;
        }
        const data = await resp.json();
        log("Token recebido com sucesso.");
        saveSpotifyToken(data);
      }catch(e){
        console.error(e);
        log("Erro no callback Spotify: " + e);
        setStatus("Erro ao conectar ao Spotify üò¢");
      }finally{
        // limpa os par√¢metros da URL pra ficar bonitinho
        url.searchParams.delete("code");
        url.searchParams.delete("state");
        url.searchParams.delete("error");
        window.history.replaceState({}, document.title, url.toString());
      }
    }

    // ==============================
    // PLAYER WEB
    // ==============================
    function initSpotifyPlayer(){
      const token = getSpotifyAccessToken();
      if(!token){
        log("N√£o h√° token v√°lido pra iniciar o player.");
        return;
      }
      if(!window.Spotify){
        log("SDK do Spotify ainda n√£o carregou.");
        return;
      }
      if(spotifyPlayer){
        log("Player Spotify j√° inicializado.");
        return;
      }

      spotifyPlayer = new Spotify.Player({
        name: "Player Pablo & Ana üíï",
        getOAuthToken: cb => { cb(token); },
        volume: 0.6
      });

      spotifyPlayer.addListener("ready", ({ device_id }) => {
        spotifyDeviceId = device_id;
        log("Player pronto com device_id = " + device_id);
        setStatus("Player pronto! Agora √© s√≥ apertar Tocar playlist üíö");
      });

      spotifyPlayer.addListener("not_ready", ({ device_id }) => {
        log("Device n√£o est√° pronto: " + device_id);
      });

      spotifyPlayer.addListener("initialization_error", ({ message }) => {
        log("Erro de inicializa√ß√£o: " + message);
      });
      spotifyPlayer.addListener("authentication_error", ({ message }) => {
        log("Erro de autentica√ß√£o: " + message);
        setStatus("Problema com o login no Spotify üò¢");
      });
      spotifyPlayer.addListener("account_error", ({ message }) => {
        log("Erro de conta: " + message);
        setStatus("Conta Spotify precisa ser Premium pra usar o Web Playback.");
      });

      spotifyPlayer.connect();
      log("Conectando player Spotify...");
    }

    async function startSpotifyPlaylist(){
      const token = getSpotifyAccessToken();
      if(!token){
        alert("Antes voc√™ precisa entrar com o Spotify üíö");
        return;
      }
      if(!spotifyPlayer || !spotifyDeviceId){
        log("Player ainda n√£o pronto, tentando iniciar...");
        initSpotifyPlayer();
        setTimeout(startSpotifyPlaylist, 1200);
        return;
      }
      try{
        log("Enviando comando de play para a playlist...");
        const resp = await fetch(
          "https://api.spotify.com/v1/me/player/play?device_id=" + encodeURIComponent(spotifyDeviceId),
          {
            method: "PUT",
            headers: {
              "Authorization": "Bearer " + token,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              context_uri: spotifyPlaylistUri
            })
          }
        );
        if(!resp.ok){
          const txt = await resp.text();
          log("Erro ao dar play: " + txt);
          alert("N√£o consegui dar play na playlist üò¢ (v√™ o log embaixo)");
        }else{
          log("Comando de play enviado com sucesso.");
          setStatus("Playlist tocando no player web do Spotify üíö");
        }
      }catch(e){
        console.error(e);
        log("Erro ao falar com o Spotify (play): " + e);
        alert("Erro ao falar com o Spotify üò¢");
      }
    }

    window.onSpotifyWebPlaybackSDKReady = () => {
      log("Spotify Web Playback SDK pronto.");
      initSpotifyPlayer();
    };

    // ==============================
    // INICIALIZA√á√ÉO
    // ==============================
    (async function(){
      await handleSpotifyCallbackIfNeeded();
      const stored = loadStoredSpotifyToken();
      if(stored){
        log("Token j√° existente, tentando iniciar player...");
        initSpotifyPlayer();
      }
    })();

    document.getElementById("spotifyLoginBtn").addEventListener("click", (ev) => {
      ev.preventDefault();
      startSpotifyLogin();
    });
    document.getElementById("spotifyPlayBtn").addEventListener("click", (ev) => {
      ev.preventDefault();
      startSpotifyPlaylist();
    });
  </script>
</body>
</html>
