<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Eu te amo Ana Clara ‚ù§</title>

  <!-- √çcones para iOS/Android -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="images/icon-192.png">
  <!-- Vers√£o raiz para iOS (garante √≠cone na tela inicial) -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-v2.png">
  <!-- Vers√£o em /images como fallback -->
  <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Ana Clara ‚ù§">
  <!-- Manifesto PWA para √≠cone na tela inicial / app web -->
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#ff4da6">


  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;600;800&family=Great+Vibes&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#ffccff;
      --bg2:#ffd6b6;
      --accent:#ff4da6;
      --accent-2:#ff8fb2;
      --card:#ffffffdd;
      --glass: rgba(255,255,255,0.15);
      --dark:#222;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Montserrat,system-ui,Arial;
      -webkit-font-smoothing:antialiased;
      background:
        radial-gradient(circle at 10% 20%, #fff3f8 0%, transparent 15%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
      overflow-x:hidden;
      overflow-y:auto;
      color:#333;
      padding-bottom: env(safe-area-inset-bottom);
      padding-top: calc(16px + env(safe-area-inset-top));
    }
    .stage{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:48px 20px;
    }
    .card{
      width:100%;
      max-width:1020px;
      background:var(--card);
      border-radius:20px;
      padding:28px;
      box-shadow:0 10px 30px rgba(0,0,0,0.12);
      position:relative;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.6);
      backdrop-filter: blur(6px);
    }
    header{
      display:flex;
      gap:16px;
      align-items:center;
    }
    .logo{
      width:84px;
      height:84px;
      border-radius:20px;
      background:linear-gradient(180deg,var(--accent),var(--accent-2));
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:800;
      font-size:28px;
      font-family: 'Great Vibes', cursive;
      box-shadow:0 6px 20px rgba(255,77,166,0.18);
      flex-shrink:0;
    }
    h1{margin:0; font-size:26px}
    p.lead{margin:4px 0 0 0; opacity:0.9}

    .main-grid{
      display:grid;
      grid-template-columns: 1.4fr 1fr;
      gap:20px;
      margin-top:18px;
    }
    @media (max-width:900px){
      .main-grid{grid-template-columns:1fr}
      .right-col{order:-1}
    }

    .left-col{padding:12px}
    .right-col{padding:12px}

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
      border-radius:12px;
      padding:14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    }

    .range-wrap{display:flex; flex-direction:column; gap:8px}
    .range-value{font-weight:700; font-size:18px; color:var(--accent)}
    input[type=range]{width:100%; accent-color:var(--accent); height:36px}

    .forgive{display:flex; gap:10px; margin-top:8px;}
    .btn{
      padding:10px 14px;
      border-radius:10px;
      border:0;
      cursor:pointer;
      font-weight:700;
      touch-action:manipulation;
      font-family:inherit;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    .btn:active{transform:scale(.97); box-shadow:none;}
    .btn-sim{
      background:linear-gradient(90deg,#ff9fc9,#ff4da6);
      color:white;
      box-shadow:0 4px 14px rgba(255,77,166,0.45);
    }
    .btn-nao{
      background:linear-gradient(90deg,#ffd6d6,#ffc9ff);
      color:#333;
    }

    .gallery{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .thumb-wrapper{
      position:relative;
      display:inline-block;
    }
    .thumb{
      width:74px;
      height:74px;
      border-radius:8px;
      object-fit:cover;
      border:3px solid white;
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
      cursor:pointer;
      display:block;
    }
    .thumb-remove{
      position:absolute;
      top:2px;
      right:2px;
      width:20px;
      height:20px;
      border-radius:999px;
      background:rgba(0,0,0,0.75);
      color:#fff;
      border:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      cursor:pointer;
    }
    .thumb-remove:hover{background:rgba(0,0,0,0.95);}

    .thumb-extra{
      width:74px;
      height:74px;
      border-radius:8px;
      border:3px dashed rgba(255,77,166,0.4);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size:15px;
      color:var(--accent);
      background:rgba(255,255,255,0.9);
      cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,0.04);
    }

    .message-box{
      margin-top:12px;
      border-radius:12px;
      padding:12px;
      background:var(--glass);
    }
    .message-box textarea{
      width:100%;
      min-height:120px;
      border-radius:8px;
      padding:12px;
      border:0;
      resize:vertical;
      font-size:15px;
      font-family:inherit;
    }
    .big-love{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
    }

    .action-row{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
    }

    footer{
      margin-top:18px;
      text-align:center;
      opacity:0.8;
      font-size:12px;
    }

    .hearts-layer{
      pointer-events:none;
      position:absolute;
      inset:0;
      overflow:hidden;
    }
    .heart{
      position:absolute;
      transform:translateY(-120%);
      will-change:transform,opacity;
      font-size:22px;
      opacity:0.9;
    }

    .burst{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .burst .bheart{
      position:absolute;
      font-size:20px;
    }

    .overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:60;
      padding:16px;
      background:rgba(0,0,0,0.25);
    }
    .overlay.show{display:flex}

    .overlay-card{
      background:linear-gradient(180deg,#fff,#ffeef8);
      border-radius:18px;
      padding:28px;
      max-width:720px;
      width:100%;
      text-align:center;
      box-shadow:0 16px 40px rgba(0,0,0,0.2);
    }
    .overlay-card h2{
      font-family:'Great Vibes',cursive;
      font-size:48px;
      margin:0;
    }
    .small{font-size:13px; opacity:0.85}

    .letter-card{
      background:#fffdf8;
      border-radius:20px;
      padding:26px 22px 22px;
      max-width:780px;
      width:100%;
      max-height:90vh;
      overflow-y:auto;
      box-shadow:0 18px 40px rgba(0,0,0,0.28);
      border:1px solid #f5e1c3;
      position:relative;
    }
    .letter-card:before{
      content:"";
      position:absolute;
      inset:12px;
      border-radius:14px;
      border:1px dashed rgba(0,0,0,0.08);
      pointer-events:none;
    }
    .ring-icon{font-size:42px; margin-bottom:8px;}
    .letter-title{
      font-family:'Great Vibes',cursive;
      font-size:40px;
      margin:0 0 8px;
      text-align:center;
    }
    .letter-body{
      text-align:left;
      font-size:15px;
      line-height:1.6;
      margin-top:8px;
    }
    .letter-body strong{color:var(--accent)}
    .footer-hearts{
      display:flex;
      gap:6px;
      justify-content:center;
      margin-top:10px;
    }

    @keyframes fall{
      to{transform:translateY(120vh) rotate(360deg); opacity:0.05}
    }

    /* Hero/carrossel */
    #heroImg{transition:opacity .6s ease;}
    #heroImg.fade-out{opacity:0;}
    #heroImg.fade-in{opacity:1;}

    /* Painel de satisfa√ß√£o */
    .satisfaction-wrapper{
      margin-top:24px;
      display:flex;
      justify-content:center;
    }
    .satisfaction-card{
      max-width:520px;
      width:100%;
      background:rgba(255,255,255,0.96);
      border-radius:18px;
      padding:18px 16px 18px;
      box-shadow:0 10px 30px rgba(0,0,0,0.12);
      border:1px solid rgba(255,255,255,0.8);
      position:relative;
      overflow:hidden;
    }
    .satisfaction-card h2{margin:0 0 4px; font-size:20px;}
    .sat-sub{margin:0 0 10px; font-size:13px; opacity:0.8;}
    .who-are-you{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
      margin-bottom:6px;
      flex-wrap:wrap;
    }
    .sat-user-btn{
      border:0;
      padding:6px 10px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      background:#ffe4f4;
      color:#b10061;
      font-weight:600;
    }
    .sat-user-btn.active{
      background:linear-gradient(90deg,#ff9fc9,#ff4da6);
      color:#fff;
    }
    .sat-current{margin:0 0 8px; font-size:12px; opacity:0.8;}
    .sat-board{
      border-radius:12px;
      background:#fff;
      border:1px solid rgba(0,0,0,0.06);
      overflow:hidden;
    }
    .sat-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 10px;
      font-size:15px;
      cursor:pointer;
    }
    .sat-row:nth-child(odd){background:#fff9fd;}
    .sat-row:nth-child(even){background:#fff;}
    .sat-row:hover{background:#ffe9f7;}
    .sat-label{flex:1;}
    .sat-markers{
      display:flex;
      gap:6px;
      min-width:80px;
      justify-content:flex-end;
    }
    .sat-marker{
      min-width:40px;
      height:32px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:15px;
      color:#fff;
      font-weight:700;
      box-shadow:0 4px 10px rgba(0,0,0,0.18);
      padding:0 8px;
      background:linear-gradient(135deg,#4f46e5,#6366f1);
    }
    .sat-marker-ana{
      background:linear-gradient(135deg,#ec4899,#f97316);
    }
    .sat-tip{margin-top:10px; font-size:11px; opacity:0.75;}
    .jail-extra textarea{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.12);
      padding:8px;
      font-size:13px;
      resize:vertical;
      font-family:inherit;
    }
    .jail-anim{
      position:absolute;
      inset:0;
      display:flex;
      justify-content:center;
      align-items:center;
      pointer-events:none;
      z-index:40;
    }
    .jail-bars{
      width:82%;
      height:70%;
      border-radius:16px;
      border:4px solid rgba(0,0,0,0.85);
      display:flex;
      justify-content:space-around;
      align-items:stretch;
      background:rgba(0,0,0,0.08);
      overflow:hidden;
      animation:jailClose 700ms ease-out forwards;
    }
    .jail-bars span{
      flex:1;
      margin:0 4px;
      background:rgba(0,0,0,0.82);
      border-radius:999px;
      transform:translateY(-120%);
      animation:barDrop 700ms ease-out forwards;
    }
    @keyframes jailClose{
      from{opacity:0; transform:scale(1.1);}
      to{opacity:1; transform:scale(1);}
    }
    @keyframes barDrop{
      from{transform:translateY(-120%);}
      to{transform:translateY(0);}
    }

    /* Contagem regressiva */
    .countdown-panel .countdown-time{
      font-size:26px;
      font-weight:800;
      color:var(--accent);
      letter-spacing:1px;
      margin:10px 0 4px;
    }
    .countdown-panel .countdown-time span{
      display:inline-block;
      min-width:52px;
    }
    .countdown-panel .countdown-msg{
      font-size:13px;
      opacity:0.85;
    }

    /* Enquetes */
    .polls-wrapper{
      margin-top:20px;
      display:flex;
      justify-content:center;
    }
    .poll-card{
      max-width:520px;
      width:100%;
    }
    .poll-card h2{margin:0 0 6px; font-size:20px;}
    .poll-sub{margin:0 0 10px; font-size:12px; opacity:0.8;}
    .poll-block{
      margin-top:10px;
      padding-top:8px;
      border-top:1px dashed rgba(0,0,0,0.08);
    }
    .poll-title{
      font-weight:600;
      margin-bottom:4px;
      font-size:15px;
    }
    .poll-options{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:4px;
    }
    .poll-btn{
      flex:1 1 100px;
    }
    .poll-btn.selected{
      box-shadow:0 0 0 2px rgba(255,77,166,0.6);
      transform:translateY(-1px);
    }
    .menu-textarea{
      width:100%;
      min-height:70px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.12);
      padding:8px;
      font-size:14px;
      resize:vertical;
      font-family:inherit;
    }

    /* Mural de recados */
    .mural-wrapper{
      margin-top:22px;
      display:flex;
      justify-content:center;
    }
    .mural-card{
      max-width:520px;
      width:100%;
    }
    .mural-form{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
      margin-bottom:10px;
    }
    .mural-input{
      flex:1 1 200px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.15);
      font-family:inherit;
      font-size:14px;
    }
    .mural-checkbox{
      display:flex;
      align-items:center;
      gap:4px;
      font-size:12px;
    }
    .mural-list{
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:220px;
      overflow-y:auto;
    }
    .mural-item{
      background:rgba(255,255,255,0.95);
      border-radius:10px;
      padding:8px 10px;
      display:flex;
      gap:8px;
      align-items:flex-start;
      border:1px solid rgba(0,0,0,0.04);
    }
    .mural-text-wrap{flex:1;}
    .mural-text{
      font-size:14px;
      margin:0;
    }
    .mural-meta{
      font-size:11px;
      opacity:0.8;
      margin-top:2px;
    }
    .mural-task .mural-text::before{
      content:"‚úî ";
      color:#16a34a;
      font-weight:600;
    }
    .mural-text.done{
      text-decoration:line-through;
      opacity:0.6;
    }
    .mural-actions{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .btn-mini{
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
      cursor:pointer;
      border:0;
      font-family:inherit;
    }
    .btn-mini-primary{
      background:#bbf7d0;
      color:#14532d;
    }
    .btn-mini-danger{
      background:#fee2e2;
      color:#7f1d1d;
    }

    /* M√∫sica */
    .music-wrapper{
      margin-top:22px;
      display:flex;
      justify-content:center;
    }
    .music-card{
      max-width:520px;
      width:100%;
    }
    .music-sub{margin:0 0 10px; font-size:12px; opacity:0.85;}
    .music-section{
      margin-top:10px;
      padding-top:8px;
      border-top:1px dashed rgba(0,0,0,0.08);
    }
    .music-section h4{
      margin:0 0 4px;
      font-size:14px;
    }
    .music-audio{
      width:100%;
    }
    .music-spotify-embed iframe{
      border-radius:12px;
      border:0;
      width:100%;
      height:80px;
    }
    .music-spotify-controls{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }
    .music-status{
      font-size:12px;
      margin-top:4px;
      opacity:0.85;
    }
    .music-log-details{
      margin-top:6px;
      font-size:11px;
    }
    .music-log{
      font-size:11px;
      background:#020617;
      color:#e5e7eb;
      padding:8px;
      border-radius:8px;
      max-height:130px;
      overflow-y:auto;
      white-space:pre-wrap;
    }

    /* Abas principais */
    .tabs-hub{
      margin-top:26px;
      background:#0f172a;
      border-radius:18px;
      padding:12px 12px 8px;
      box-shadow:0 16px 38px rgba(15,23,42,0.25);
      border:1px solid rgba(255,255,255,0.08);
      color:#e2e8f0;
    }
    .tabs-title{
      font-size:13px;
      font-weight:700;
      letter-spacing:0.4px;
      opacity:0.8;
      margin:0 0 6px 4px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .tabs-title span{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:20px;
      height:20px;
      border-radius:999px;
      background:linear-gradient(120deg,#ff9fc9,#ff4da6);
      color:#0f172a;
      font-weight:800;
      font-size:12px;
    }
    .tabs-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      overflow-x:auto;
      padding-bottom:6px;
      scrollbar-width:thin;
      scrollbar-color:rgba(255,255,255,0.25) transparent;
    }
    .tabs-row::-webkit-scrollbar{height:6px;}
    .tabs-row::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,0.25);
      border-radius:99px;
    }
    .tab-btn{
      border:0;
      background:rgba(255,255,255,0.06);
      color:#e2e8f0;
      padding:12px 14px;
      border-radius:999px;
      font-weight:800;
      letter-spacing:0.1px;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(0,0,0,0.2);
      transition:transform .12s ease, box-shadow .12s ease, background .18s ease, color .18s ease;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .tab-btn small{
      font-size:11px;
      opacity:0.7;
      font-weight:700;
    }
    .tab-btn:hover{transform:translateY(-2px);}
    .tab-btn.active{
      background:#f8fafc;
      color:#0f172a;
      box-shadow:0 10px 26px rgba(255,77,166,0.35);
    }
    .tab-btn.active small{opacity:0.8;}
    .tab-hidden{display:none!important;}

    /* Retrospectiva */
    .retro-section .retro-hero{
      background:linear-gradient(135deg,#111827,#0f172a);
      color:#f8fafc;
      border-radius:16px;
      padding:18px 16px;
      display:grid;
      grid-template-columns:1.4fr 1fr;
      gap:14px;
      box-shadow:0 12px 32px rgba(0,0,0,0.22);
      border:1px solid rgba(255,255,255,0.08);
      position:relative;
      overflow:hidden;
    }
    .retro-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,0.08);
      font-size:12px;
      font-weight:700;
      width:max-content;
    }
    .retro-hero h3{
      margin:6px 0 4px;
      font-size:24px;
      letter-spacing:0.2px;
    }
    .retro-hero p{margin:0; opacity:0.88;}
    .retro-cta{
      display:flex;
      align-items:flex-end;
      justify-content:flex-end;
    }
    .retro-cta button{
      border:0;
      background:linear-gradient(135deg,#ff9fc9,#ff4da6);
      color:#0f172a;
      font-weight:900;
      padding:12px 16px;
      border-radius:14px;
      cursor:pointer;
      box-shadow:0 12px 30px rgba(255,77,166,0.35);
      font-size:14px;
      letter-spacing:0.2px;
    }
    .retro-grid{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:10px;
    }
    .retro-card{
      background:#0b1222;
      color:#e2e8f0;
      border-radius:12px;
      padding:12px;
      box-shadow:0 10px 24px rgba(0,0,0,0.2);
      border:1px solid rgba(255,255,255,0.06);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .retro-card strong{font-size:15px;}
    .retro-card small{opacity:0.8;}
    .retro-accent{
      color:#ff9fc9;
      font-weight:800;
    }
    .retro-subline{
      margin-top:4px;
      font-size:12px;
      opacity:0.75;
    }
    .retro-canvas{
      position:absolute;
      inset:0;
      pointer-events:none;
      background:radial-gradient(circle at 18% 30%, rgba(255,77,166,0.18), transparent 30%),
                 radial-gradient(circle at 78% 70%, rgba(255,143,178,0.16), transparent 34%);
    }

    /* Overlay galeria cheia */
    #galleryOverlay .overlay-card{
      max-width:860px;
      text-align:left;
    }
    #fullGallery{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    @media (max-width:900px){
      .stage{
        align-items:flex-start;
        padding:24px 12px 32px;
      }
    }
    @media (max-width:420px){
      .card{padding:18px; border-radius:16px}
      header{gap:12px}
      .logo{width:70px;height:70px;font-size:24px}
      h1{font-size:20px}
      .overlay-card{padding:20px}
      .overlay-card h2{font-size:34px}
      .letter-card{padding:20px 16px}
      .letter-title{font-size:32px}

      .main-grid{grid-template-columns:1fr}
      .right-col{order:2}
      .left-col{order:1}

      .forgive{flex-direction:column}
      .forgive .btn{width:100%; padding:12px; font-size:16px}
      .action-row{flex-direction:column}
      .action-row .btn{width:100%}

      .thumb,
      .thumb-extra{width:64px;height:64px}
      .message-box textarea{min-height:100px}

      .heart{font-size:26px}
      .satisfaction-card{padding:14px 12px 16px;}
      .satisfaction-card h2{font-size:17px;}
      .sat-row{padding:8px 8px; font-size:14px;}
    }
    @media (max-width:360px){
      .logo{width:60px;height:60px;font-size:20px}
      h1{font-size:18px}
      .overlay-card h2{font-size:28px}
      .thumb,
      .thumb-extra{width:56px;height:56px}
    }
    @media (hover:none){
      .btn{padding:14px 16px; border-radius:12px}
      input[type=range]{height:44px}
    }
    @media (max-width:700px){
      .overlay{
        align-items:flex-start;
        justify-content:center;
        overflow-y:auto;
      }
      .letter-card,
      .overlay-card{
        margin-top:40px;
        margin-bottom:40px;
      }
    }

    /* Hub compacto com abas e hamb√∫rguer */
    .hub-card{
      margin-top:22px;
      border:1px solid rgba(0,0,0,0.05);
      border-radius:16px;
      background:linear-gradient(180deg, #fff, #fff5fb);
      box-shadow:0 12px 26px rgba(0,0,0,0.08);
      overflow:hidden;
    }
    .hub-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      gap:10px;
      border-bottom:1px solid rgba(0,0,0,0.04);
      background:linear-gradient(90deg,rgba(255,77,166,0.08),rgba(255,143,178,0.12));
    }
    .hub-title{margin:0; font-size:16px; font-weight:800; color:#b10061;}
    .hub-nav-btn{
      border:0;
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:6px;
      box-shadow:0 6px 12px rgba(0,0,0,0.06);
      cursor:pointer;
    }
    .hub-menu{display:none; padding:12px; border-bottom:1px solid rgba(0,0,0,0.04); background:#fff;}
    .hub-menu.show{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px;}
    .hub-menu button{
      border:0;
      padding:10px 12px;
      background:#fff6fb;
      border-radius:12px;
      font-weight:700;
      color:#a00063;
      cursor:pointer;
      box-shadow:0 4px 10px rgba(0,0,0,0.05);
    }
    .hub-menu button.active{
      background:linear-gradient(90deg,#ff9fc9,#ff4da6);
      color:#fff;
    }
    .hub-section{display:none; padding:14px; background:#fff;}
    .hub-section.active{display:block;}
    .hub-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:12px;}
    .hub-box{
      padding:12px;
      border-radius:12px;
      background:#fff8ff;
      border:1px solid rgba(0,0,0,0.04);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.9);
    }
    .hub-box h3{margin-top:0; margin-bottom:4px;}
    .hub-box small{opacity:0.8;}
    .input-row{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;}
    .input-row input, .input-row select, .input-row textarea{flex:1; padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,0.08); font-family:inherit;}
    .tag{display:inline-flex; padding:4px 8px; border-radius:999px; font-size:11px; background:#ffe3f3; color:#a00063; margin-right:6px;}
    .list{margin:0; padding:0; list-style:none; display:flex; flex-direction:column; gap:8px;}
    .list li{background:#fff; padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,0.05);}
    .badge{display:inline-flex; padding:4px 8px; border-radius:999px; font-size:12px; background:#e0f2fe; color:#0b4f71;}
    .pill{display:inline-flex; padding:4px 8px; border-radius:999px; font-size:12px; background:#dcfce7; color:#166534;}
    .locked{opacity:0.65;}
    .wheel{width:100%; height:180px; background:conic-gradient(#ff9fc9 0 25%, #ffe6f4 25% 50%, #ffd6b6 50% 75%, #c4f1f5 75% 100%); border-radius:14px; display:flex; align-items:center; justify-content:center; font-weight:800; color:#b10061;}
    .progress{height:10px; border-radius:999px; background:rgba(0,0,0,0.05); overflow:hidden;}
    .progress span{display:block; height:100%; background:linear-gradient(90deg,#ff9fc9,#ff4da6);}
    .chart-row{display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px;}
  
    /* Se√ß√µes extras (nossa hist√≥ria, mapa, bucket list etc.) */
    .extra-section{
      margin-top:24px;
    }
    .extra-card h2{
      margin-top:0;
      font-size:20px;
    }
    .extra-card .small{
      font-size:13px;
      opacity:0.85;
    }
    .extra-form{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .extra-input{
      width:100%;
      border-radius:8px;
      border:1px solid rgba(0,0,0,0.08);
      padding:8px 10px;
      font-family:inherit;
      font-size:14px;
    }
    .extra-textarea{
      min-height:70px;
      resize:vertical;
    }
    .extra-list{
      list-style:none;
      padding:0;
      margin:10px 0 0;
      max-height:280px;
      overflow-y:auto;
    }
    .extra-list li{
      border-radius:10px;
      padding:8px 10px;
      background:rgba(255,255,255,0.9);
      box-shadow:0 2px 6px rgba(0,0,0,0.04);
      font-size:14px;
      display:flex;
      flex-direction:column;
      gap:2px;
      margin-bottom:6px;
    }
    .extra-list li .extra-meta{
      font-size:11px;
      opacity:0.7;
    }
    .extra-list-check li{
      flex-direction:row;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
    }
    .extra-list-check label{
      flex:1;
      display:flex;
      gap:6px;
      align-items:flex-start;
      font-size:14px;
    }
    .extra-list-check input[type=checkbox]{
      margin-top:3px;
    }
    .extra-list-links a{
      word-break:break-all;
      font-size:13px;
    }
    .calendar-form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows:auto auto;
      gap:6px;
    }
    .calendar-form #eventTitle{
      grid-column:1 / span 2;
    }
    .calendar-form #eventAddBtn{
      grid-column:1 / span 2;
    }
    .lovejar-random{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .lovejar-details{
      margin-top:8px;
    }
    .lovejar-details summary{
      cursor:pointer;
    }
    .quiz-question{
      margin-top:10px;
      padding:10px;
      border-radius:10px;
      background:rgba(255,255,255,0.9);
      box-shadow:0 2px 6px rgba(0,0,0,0.04);
    }
    .quiz-options{
      margin-top:6px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .quiz-option-btn{
      border-radius:8px;
      border:1px solid rgba(0,0,0,0.06);
      padding:6px 8px;
      text-align:left;
      cursor:pointer;
      background:#fff;
      font-size:14px;
    }
    .quiz-option-btn.selected-correct{
      background:#e6ffe6;
      border-color:#8cd98c;
    }
    .quiz-option-btn.selected-wrong{
      background:#ffe6e6;
      border-color:#ff9999;
    }
    .mood-section canvas{
      margin-top:10px;
      width:100%;
      max-width:100%;
      background:#fff;
      border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.06);
    }
    .extra-card .btn{
      align-self:flex-start;
    }
    @media (max-width:700px){
      .calendar-form{
        grid-template-columns:1fr;
      }
      .calendar-form #eventTitle,
      .calendar-form #eventAddBtn{
        grid-column:auto;
      }
    }

    /* ==== RETROSPECTIVA TIPO SPOTIFY WRAPPED ==== */
    .love-wrapped-section{
      margin-top:40px;
    }
    .love-wrapped-card{
      background: radial-gradient(circle at top left,#ff9fc9,#ff4da6 35%,#1b1b2f 75%);
      border-radius:24px;
      padding:26px 28px;
      color:#fff;
      box-shadow:0 18px 40px rgba(0,0,0,0.32);
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .love-wrapped-tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      background:rgba(0,0,0,0.35);
    }
    .love-wrapped-tag-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:#fffb;
    }
    .love-wrapped-title{
      font-size:26px;
      margin:0;
    }
    .love-wrapped-sub{
      font-size:14px;
      max-width:420px;
      opacity:.9;
    }
    .love-wrapped-main-metric{
      margin-top:8px;
    }
    .love-wrapped-label{
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:.08em;
      opacity:.85;
    }
    .love-wrapped-number{
      font-size:38px;
      font-weight:800;
      line-height:1.1;
      margin-top:4px;
    }
    .love-wrapped-number span{
      display:inline-block;
    }
    .love-wrapped-unit{
      font-size:18px;
      opacity:.85;
      margin-left:4px;
    }
    .love-wrapped-note{
      font-size:13px;
      opacity:.9;
      max-width:380px;
    }
    .love-wrapped-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:14px;
      margin-top:12px;
    }
    .love-wrapped-mini{
      background:rgba(0,0,0,0.22);
      border-radius:18px;
      padding:10px 12px;
      font-size:13px;
    }
    .love-wrapped-mini-label{
      font-size:11px;
      opacity:.85;
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .love-wrapped-mini-number{
      font-size:18px;
      font-weight:700;
      margin-top:4px;
    }
    .love-wrapped-mini-note{
      font-size:11px;
      opacity:.85;
      margin-top:3px;
    }
    .love-wrapped-secondary{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:12px;
      margin-top:10px;
    }
    .love-wrapped-secondary-card{
      background:#111321;
      border-radius:18px;
      padding:12px 14px;
      color:#fff;
      font-size:13px;
      box-shadow:0 8px 22px rgba(0,0,0,0.4);
    }
    .love-wrapped-secondary-title{
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:.08em;
      opacity:.9;
    }
    .love-wrapped-secondary-number{
      font-size:22px;
      font-weight:700;
      margin-top:4px;
    }
    .love-wrapped-secondary-note{
      font-size:11px;
      opacity:.85;
      margin-top:4px;
    }
    @media (max-width:800px){
      .love-wrapped-card{
        padding:20px 18px;
        border-radius:20px;
      }
      .love-wrapped-title{
        font-size:22px;
      }
      .love-wrapped-grid{
        grid-template-columns:1fr;
      }
      .love-wrapped-secondary{
        grid-template-columns:1fr;
      }
    }
</style>
</head>
<body>
  <div class="stage">
    <div class="card" id="card">
      <div class="hearts-layer" id="heartsLayer"></div>

      <header>
        <div class="logo">‚ù§</div>
        <div>
          <h1>Eu te amo, Ana Clara</h1>
          <p class="lead">Um site s√≥ pra voc√™ ‚Äî com muito amor, carinho, m√∫sicas e cora√ß√µes üíñ</p>
        </div>
      </header>

      <div class="hub-card" id="megaHub">
        <div class="hub-header">
          <h3 class="hub-title">Central secreta de voc√™s (com abas) ‚ú®</h3>
          <button class="hub-nav-btn" id="hubToggle">‚ò∞ Abrir menu</button>
        </div>
        <div class="hub-menu" id="hubMenu">
          <button data-target="hub-login" class="active">Login / Perfis</button>
          <button data-target="hub-chat">Bilhetes & Time-capsule</button>
          <button data-target="hub-fun">Roleta & Cupons</button>
          <button data-target="hub-viagem">Planner da viagem</button>
          <button data-target="hub-achievements">Achievements & Timeline</button>
          <button data-target="hub-stats">Resumo & PWA</button>
        </div>

        <div class="hub-section active" id="hub-login">
          <div class="hub-grid">
            <div class="hub-box">
              <h3>Login leve com PIN üîí</h3>
              <small>Escolha quem √© voc√™ e digite o PIN fofinho de 4 d√≠gitos.</small>
              <div class="input-row">
                <select id="hubUser">
                  <option value="pablo">Pablo</option>
                  <option value="ana">Ana</option>
                </select>
                <input id="hubPin" type="password" inputmode="numeric" maxlength="4" placeholder="PIN (ex.: 1234)">
              </div>
              <div class="input-row">
                <button class="btn btn-sim" id="hubLoginBtn">Entrar</button>
                <button class="btn btn-nao" id="hubPinSaveBtn">Atualizar PIN</button>
              </div>
              <div id="hubLoginStatus" class="small"></div>
            </div>
            <div class="hub-box">
              <h3>Resumo r√°pido do m√™s üìÖ</h3>
              <small>Mostra tudo que rolou usando os registros do site.</small>
              <div class="input-row">
                <input id="hubResumoMes" type="month">
                <button class="btn btn-sim" id="hubResumoBtn">Calcular</button>
              </div>
              <div id="hubResumoDados" class="small"></div>
            </div>
          </div>
        </div>

        <div class="hub-section" id="hub-chat">
          <div class="hub-grid">
            <div class="hub-box">
              <h3>Bilhetes em tempo real üíå</h3>
              <small>Filtre por categoria e veja se h√° novidade.</small>
              <div class="input-row">
                <select id="msgAuthor">
                  <option value="pablo">Pablo</option>
                  <option value="ana">Ana</option>
                </select>
                <select id="msgType">
                  <option value="fofura">Fofura</option>
                  <option value="segredo">Segredo</option>
                  <option value="safadeza">Safadeza</option>
                </select>
              </div>
              <div class="input-row">
                <input id="msgText" type="text" placeholder="Escreva um recado" />
                <button class="btn btn-sim" id="sendMsgBtn">Enviar</button>
              </div>
              <div class="input-row">
                <select id="msgFilter">
                  <option value="todos">Todos</option>
                  <option value="fofura">S√≥ fofos</option>
                  <option value="segredo">S√≥ segredos</option>
                  <option value="safadeza">S√≥ safadeza</option>
                </select>
                <span class="badge" id="msgUnread">0 novos</span>
              </div>
              <ul class="list" id="msgList"></ul>
            </div>
            <div class="hub-box">
              <h3>Cartas para o futuro ‚è≥</h3>
              <small>Escolha a data de abertura e deixe o futuro cuidar.</small>
              <div class="input-row">
                <input id="capsTitle" type="text" placeholder="T√≠tulo da carta">
                <input id="capsFrom" type="text" placeholder="De">
                <input id="capsTo" type="text" placeholder="Para">
              </div>
              <div class="input-row">
                <textarea id="capsText" placeholder="Escreva a carta" rows="3"></textarea>
              </div>
              <div class="input-row">
                <input id="capsDate" type="date">
                <button class="btn btn-sim" id="capsSaveBtn">Guardar</button>
              </div>
              <ul class="list" id="capsList"></ul>
            </div>
          </div>
        </div>

        <div class="hub-section" id="hub-fun">
          <div class="hub-grid">
            <div class="hub-box">
              <h3>Roleta do amor üé°</h3>
              <small>Cadastre atividades e gire.</small>
              <div class="input-row">
                <input id="wheelItem" type="text" placeholder="Nova atividade (massagem, filme...)" />
                <select id="wheelMode">
                  <option value="amor">Mimo</option>
                  <option value="castigo">Castigo</option>
                </select>
                <button class="btn btn-sim" id="wheelAddBtn">Adicionar</button>
              </div>
              <div class="wheel" id="wheelResult">Clique em girar</div>
              <div class="input-row">
                <button class="btn btn-sim" id="wheelSpinBtn">Girar roleta</button>
                <button class="btn btn-nao" id="wheelClearBtn">Limpar op√ß√µes</button>
              </div>
              <ul class="list" id="wheelList"></ul>
            </div>
            <div class="hub-box">
              <h3>Cupons do amor üéüÔ∏è</h3>
              <small>Registre cupons e marque quando usar.</small>
              <div class="input-row">
                <input id="couponText" type="text" placeholder="Vale um abra√ßo longo" />
                <button class="btn btn-sim" id="couponAddBtn">Criar cupom</button>
              </div>
              <div class="input-row">
                <span class="badge" id="couponStats">0 cupons</span>
              </div>
              <ul class="list" id="couponList"></ul>
            </div>
          </div>
        </div>

        <div class="hub-section" id="hub-viagem">
          <div class="hub-grid">
            <div class="hub-box">
              <h3>Meta de viagem ‚úàÔ∏è</h3>
              <small>Quanto falta para a viagem dos sonhos.</small>
              <div class="input-row">
                <input id="goalValue" type="number" min="0" step="50" placeholder="Meta em R$">
                <button class="btn btn-sim" id="goalSaveBtn">Salvar meta</button>
              </div>
              <div class="input-row">
                <input id="goalWho" type="text" placeholder="Quem contribuiu?">
                <input id="goalAmount" type="number" min="0" step="10" placeholder="Valor" />
                <button class="btn btn-nao" id="goalAddBtn">Registrar contribui√ß√£o</button>
              </div>
              <div class="progress"><span id="goalProgress" style="width:0%"></span></div>
              <div id="goalStatus" class="small"></div>
              <ul class="list" id="goalList"></ul>
            </div>
            <div class="hub-box">
              <h3>Roteiro & Mapa üó∫Ô∏è</h3>
              <small>Planeje etapas como cap√≠tulos de viagem.</small>
              <div class="input-row">
                <input id="routePlace" type="text" placeholder="Lugar / data" />
                <input id="routeBudget" type="text" placeholder="Or√ßamento estimado" />
                <button class="btn btn-sim" id="routeAddBtn">Adicionar</button>
              </div>
              <ul class="list" id="routeList"></ul>
            </div>
          </div>
        </div>

        <div class="hub-section" id="hub-achievements">
          <div class="hub-grid">
            <div class="hub-box">
              <h3>Achievements do casal üèÜ</h3>
              <small>Desbloqueia conforme voc√™s usam o site.</small>
              <ul class="list" id="achList"></ul>
            </div>
            <div class="hub-box">
              <h3>Timeline em cap√≠tulos üìñ</h3>
              <div class="input-row">
                <input id="chapterTitle" type="text" placeholder="T√≠tulo do cap√≠tulo">
                <input id="chapterCat" type="text" placeholder="Categoria (encontro, viagem...)" />
              </div>
              <div class="input-row">
                <textarea id="chapterText" rows="3" placeholder="Mini cr√¥nica"></textarea>
              </div>
              <button class="btn btn-sim" id="chapterAddBtn">Salvar cap√≠tulo</button>
              <ul class="list" id="chapterList"></ul>
            </div>
            <div class="hub-box">
              <h3>Di√°rio compartilhado üìì</h3>
              <div class="input-row">
                <input id="diaryDate" type="date">
                <textarea id="diaryText" rows="2" placeholder="Texto do dia"></textarea>
              </div>
              <button class="btn btn-sim" id="diarySaveBtn">Registrar</button>
              <ul class="list" id="diaryList"></ul>
            </div>
          </div>
        </div>

        <div class="hub-section" id="hub-stats">
          <div class="hub-grid">
            <div class="hub-box">
              <h3>Painel de dados ‚ù§Ô∏è‚Äçüî•</h3>
              <div class="chart-row" id="statsCards"></div>
              <canvas id="statsCanvas" width="320" height="180" style="width:100%; margin-top:8px; background:#fff; border-radius:8px;"></canvas>
            </div>
            <div class="hub-box">
              <h3>Modo offline & push üîî</h3>
              <p class="small">Registramos um Service Worker pra cachear e preparar push pelo Firebase mais tarde.</p>
              <button class="btn btn-sim" id="pwaRegisterBtn">Ativar modo offline</button>
              <div id="pwaStatus" class="small"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="main-grid">
        <div class="left-col">
          <div class="panel">
            <h3>Quanto voc√™ ama o Pablo?</h3>
            <div class="range-wrap">
              <div style="display:flex; align-items:center; justify-content:space-between">
                <div class="range-value">N√≠vel: <span id="loveVal">10</span>/10</div>
                <div class="small">Deslize para escolher</div>
              </div>
              <input id="loveRange" type="range" min="0" max="10" step="1" value="10">
              <small class="small">Dica: ele merece 10 sempre üòâ</small>
            </div>

            <hr style="margin:12px 0">

            <h3>Perdoa o Pablo?</h3>
            <div class="forgive">
              <button class="btn btn-sim" id="btnSim">SIM</button>
              <button class="btn btn-nao" id="btnNao">N√ÉO</button>
            </div>

            <div style="margin-top:12px">
              <label class="small">Fotos nossas:</label>
              <div class="gallery" id="gallery"></div>
              <small class="small" style="display:block; margin-top:4px;">
                Voc√™s podem adicionar fotos direto do celular. Elas ficam salvas e aparecem em todos os dispositivos üíñ
              </small>
              <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
                <input id="fileInput" type="file" accept="image/*" multiple style="flex:1 1 180px;">
                <button class="btn btn-sim" id="savePhotosBtn" style="flex:0 0 auto;">Salvar fotos</button>
              </div>
            </div>
          </div>

          <div class="panel message-box">
            <div class="big-love">
              <strong>Mensagem do Pablo pra voc√™</strong>
              <div class="footer-hearts">‚ù§ ‚ù§ ‚ù§</div>
            </div>
            <textarea id="loveMsg">Ana Clara, cada batida do meu cora√ß√£o lembra seu nome. Voc√™ √© minha companheirinha, meu sorriso e meu porto seguro. Eu te amo mais do que palavras conseguem dizer. Sempre seu, Pablo.</textarea>
            <div class="action-row">
              <button class="btn btn-sim" id="showMsg">Mostrar em grande</button>
              <button class="btn btn-nao" id="surprise">Surpresa (cora√ß√µes)</button>
              <button class="btn btn-sim" id="proposalBtn">Clique aqui para descobrir üíå</button>
            </div>
          </div>
        </div>

        <aside class="right-col">
          <div class="panel" style="text-align:center">
            <h3>Galeria & momento</h3>
            <p class="small">As fotos v√£o passando sozinhas, mas voc√™ pode tocar em qualquer miniatura pra escolher üíï</p>
            <div style="margin-top:10px">
              <img id="heroImg" src="images/wedding.jpg" alt="foto destaque" style="width:100%; border-radius:12px; display:block; object-fit:cover; max-height:320px">
            </div>
            <div style="margin-top:12px; text-align:left">
              <small class="small">Dica: se o slider ficar menor que 10, ele volta pra 10 automaticamente ‚Äî porque voc√™ merece tudo.</small>
            </div>
          </div>

          <div style="height:14px"></div>

          <!-- Contagem regressiva para o encontro -->
          <div class="panel countdown-panel" style="text-align:center">
            <h3>Contagem para nosso pr√≥ximo encontro ‚è≥</h3>
            <p class="small">
              Encontro em <strong>19/11/2025 √†s 18h</strong> (hor√°rio de Bras√≠lia).
            </p>
            <div class="countdown-time" id="countdownTime">
              --d --h --m --s
            </div>
            <p class="small countdown-msg" id="countdownMsg">
              Carregando contagem...
            </p>
          </div>

          <div style="height:14px"></div>

          <div class="panel" style="text-align:center">
            <h3>Brilhos & Cora√ß√µes</h3>
            <p class="small">Cora√ß√µes caem na p√°gina quando voc√™ visita ou quando algo especial acontece.</p>
            <div style="margin-top:8px">
              <button class="btn btn-sim" id="popupLove">Mostrar Amor</button>
            </div>
          </div>
        </aside>
      </div>

      <!-- Painel de satisfa√ß√£o -->
      <div class="tabs-hub">
        <p class="tabs-title"><span>*</span>Menu rapido</p>
        <div class="tabs-row" id="tabButtons">
          <button class="tab-btn active" data-tab="tudo">Tudo</button>
          <button class="tab-btn" data-tab="painel">Painel</button>
          <button class="tab-btn" data-tab="enquetes">Enquetes</button>
          <button class="tab-btn" data-tab="retrospectiva">Retrospectiva</button>
          <button class="tab-btn" data-tab="mural">Mural</button>
          <button class="tab-btn" data-tab="historia">Historia</button>
          <button class="tab-btn" data-tab="lugares">Lugares</button>
          <button class="tab-btn" data-tab="sonhos">Sonhos</button>
          <button class="tab-btn" data-tab="pote">Pote do amor</button>
          <button class="tab-btn" data-tab="quiz">Quiz</button>
          <button class="tab-btn" data-tab="videos">Videos</button>
          <button class="tab-btn" data-tab="agenda">Calendario</button>
          <button class="tab-btn" data-tab="humor">Humor</button>
          <button class="tab-btn" data-tab="ideias">Inspiracoes</button>
          <button class="tab-btn" data-tab="notif">Notificacoes</button>
          <button class="tab-btn" data-tab="musica">Musica</button>
        </div>
      </div>

      <section class="satisfaction-wrapper tab-panel" data-tab-section="painel">
        <div class="satisfaction-card">
          <h2>N√≠vel de satisfa√ß√£o com o moz√£o üòè</h2>
          <p class="sat-sub">
            Escolha quem voc√™ √© e clique em um n√≠vel. Cada voto mexe o marcador da outra pessoa.
          </p>

          <div class="who-are-you">
            <span>Eu sou:</span>
            <button class="sat-user-btn" data-user="pablo">Pablo (namorado)</button>
            <button class="sat-user-btn" data-user="ana">Ana Clara (namorada)</button>
          </div>
          <p class="sat-current">
            Voc√™ est√° logado como: <strong id="satCurrentUser">ningu√©m</strong>
          </p>

          <div class="sat-board">
            <div class="sat-row" data-level="perfect">
              <span class="sat-label">Amorzinho perfeito(a) üíò</span>
              <div class="sat-markers"></div>
            </div>
            <div class="sat-row" data-level="good">
              <span class="sat-label">Muito bonzinho(a) ‚≠ê</span>
              <div class="sat-markers"></div>
            </div>
            <div class="sat-row" data-level="chill">
              <span class="sat-label">De boa / Chill üòé</span>
              <div class="sat-markers"></div>
            </div>
            <div class="sat-row" data-level="ice">
              <span class="sat-label">Em gelo fino üßä</span>
              <div class="sat-markers"></div>
            </div>
            <div class="sat-row" data-level="jail">
              <span class="sat-label">Cadeia (ai, ai, ai) ‚õìÔ∏è</span>
              <div class="sat-markers"></div>
            </div>
          </div>

          <!-- Marcadores -->
          <div class="sat-marker sat-marker-pablo" data-user="pablo">P üíò</div>
          <div class="sat-marker sat-marker-ana" data-user="ana">A üíò</div>

          <p class="sat-tip">
            Quando voc√™ entra como Ana, mexe o P (avaliando o Pablo). Quando entra como Pablo, mexe o A (avaliando a Ana).
          </p>

          <div class="jail-extra" id="jailExtra" style="display:none; margin-top:10px;">
            <p id="jailLabel" class="sat-sub" style="margin-bottom:6px;"></p>
            <textarea id="jailText" rows="3" placeholder="Escreva aqui o que a pessoa precisa fazer para sair da cadeia..."></textarea>
            <button class="btn btn-nao" id="jailSaveBtn" style="margin-top:6px; width:100%;">Salvar plano para sair da cadeia</button>
          </div>
        </div>
      </section>

      <!-- ENQUETES -->
      <section class="polls-wrapper tab-panel" data-tab-section="enquetes">
        <div class="panel poll-card">
          <h2>Enquetes do dia üí≠</h2>
          <p class="poll-sub">As respostas ficam salvas pra voc√™s dois verem, em qualquer dispositivo.</p>

          <div class="poll-block" id="pollSexo">
            <div class="poll-title">Sexo hoje: sim ou n√£o? üòè</div>
            <div class="poll-options">
              <button class="btn btn-sim poll-btn" data-poll="sexo" data-value="sim">Sim üòà</button>
              <button class="btn btn-nao poll-btn" data-poll="sexo" data-value="nao">N√£o üôÖ‚Äç‚ôÄÔ∏è</button>
            </div>
            <p class="small" id="pollSexoStatus" style="margin-top:6px;">Ainda sem resposta hoje.</p>
          </div>

          <div class="poll-block" id="pollMenu">
            <div class="poll-title">Card√°pio do dia üçΩÔ∏è</div>
            <textarea id="menuInput" class="menu-textarea" placeholder="Ex.: noite do macarr√£o, pedir sushi, ver filme com pipoca..."></textarea>
            <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn btn-sim" id="menuSaveBtn">Salvar card√°pio</button>
            </div>
            <p class="small" id="menuStatus" style="margin-top:6px;">Sem sugest√£o ainda. Escrevam algo gostoso pra hoje üòã</p>
          </div>
        </div>
      </section>

      <!-- RETROSPECTIVA -->
      <section class="extra-section retro-section tab-panel" data-tab-section="retrospectiva">
        <div class="love-wrapped-section">
          <div class="panel love-wrapped-card">
            <div class="love-wrapped-tag">
              <span class="love-wrapped-tag-dot"></span>
              <span>Retrospectiva do casal ‚Ä¢ 2025</span>
            </div>

            <h2 class="love-wrapped-title">Sua retrospectiva 2025 üíï</h2>
            <p class="love-wrapped-sub">
              Um Wrapped vers√£o relacionamento: em vez de horas de m√∫sica, aqui s√£o as
              <strong>horas que voc√™s passaram juntos</strong> desde o primeiro encontro.
            </p>

            <div class="love-wrapped-main-metric">
              <div class="love-wrapped-label">Horas juntos desde 06/07/2023</div>
              <div class="love-wrapped-number">
                <span id="wrHoursTogether">--</span><span class="love-wrapped-unit">h</span>
              </div>
              <p class="love-wrapped-note">
                √â como se uma playlist tivesse dado play l√° em julho de 2023 e nunca tivesse parado.
              </p>
            </div>

            <div class="love-wrapped-grid">
              <div class="love-wrapped-mini">
                <div class="love-wrapped-mini-label">Dias juntos</div>
                <div class="love-wrapped-mini-number" id="wrDaysTogether">--</div>
                <div class="love-wrapped-mini-note">
                  Desde 06/07/2023 contando cada ‚Äúoi‚Äù, cada rol√™ e cada cochilo na call.
                </div>
              </div>

              <div class="love-wrapped-mini">
                <div class="love-wrapped-mini-label">Dias de namoro</div>
                <div class="love-wrapped-mini-number" id="wrDaysDating">--</div>
                <div class="love-wrapped-mini-note">
                  Oficialmente namorando desde 23/09/2023. Spoiler: deu muito certo.
                </div>
              </div>

              <div class="love-wrapped-mini">
                <div class="love-wrapped-mini-label">Horas s√≥ em 2025</div>
                <div class="love-wrapped-mini-number" id="wrHoursYear">-- h</div>
                <div class="love-wrapped-mini-note">
                  S√≥ esse ano voc√™s j√° somaram esse tanto de horas sendo ‚ÄúPablo + Ana‚Äù.
                </div>
              </div>
            </div>

            <div class="love-wrapped-secondary">
              <div class="love-wrapped-secondary-card">
                <div class="love-wrapped-secondary-title">Top artista do seu ano</div>
                <div class="love-wrapped-secondary-number">Ana Clara üëë</div>
                <div class="love-wrapped-secondary-note">
                  Presen√ßa confirmada em 100% das melhores mem√≥rias da playlist ‚ÄúVida do Pablo‚Äù.
                </div>
              </div>

              <div class="love-wrapped-secondary-card">
                <div class="love-wrapped-secondary-title">G√™nero mais tocado</div>
                <div class="love-wrapped-secondary-number">Amorzinho intenso</div>
                <div class="love-wrapped-secondary-note">
                  Com uma pitada de drama, muito carinho e algumas horas extras de saudade.
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- MURAL DE RECADOS -->
      <section class="mural-wrapper tab-panel" data-tab-section="mural">
        <div class="panel mural-card">
          <h2>Muralzinho de recados ‚úçÔ∏è</h2>
          <p class="small">
            Deixem lembretes, miss√µes ou recados fofos um pro outro. Tudo fica salvo pra voc√™s dois.
          </p>

          <div class="mural-form">
            <input id="muralText" class="mural-input" placeholder="Ex.: comprar chocolate, noite do filme, mensagem fofa..." />
            <label class="mural-checkbox">
              <input type="checkbox" id="muralIsTask" />
              miss√£o
            </label>
            <button class="btn btn-sim" id="muralAddBtn">Adicionar</button>
          </div>

          <ul id="muralList" class="mural-list"></ul>
        </div>
      </section>


      <!-- NOSSA HIST√ìRIA -->
      <section class="extra-section timeline-section tab-panel" data-tab-section="historia">
        <div class="panel extra-card">
          <h2>Nossa hist√≥ria de amor üóìÔ∏è</h2>
          <p class="small">
            Uma linha do tempo com os momentos mais importantes. Voc√™s podem ir adicionando aos poucos.
          </p>
          <div class="extra-form">
            <input type="date" id="timelineDate" class="extra-input" />
            <input type="text" id="timelineTitle" class="extra-input" placeholder="T√≠tulo do momento (ex.: primeiro encontro)" />
            <textarea id="timelineDesc" class="extra-input extra-textarea" placeholder="Detalhes fofos, mem√≥rias, sensa√ß√µes..."></textarea>
            <button class="btn btn-sim" id="timelineAddBtn">Adicionar √† linha do tempo</button>
          </div>
          <ul id="timelineList" class="extra-list"></ul>
        </div>
      </section>

      <!-- MAPA / LUGARES ESPECIAIS -->
      <section class="extra-section places-section tab-panel" data-tab-section="lugares">
        <div class="panel extra-card">
          <h2>Mapa de mem√≥rias üåç</h2>
          <p class="small">
            Guardem os lugares especiais de voc√™s. Cada item abre o lugar no Google Maps.
          </p>
          <div class="extra-form">
            <input type="text" id="placeName" class="extra-input" placeholder="Nome do lugar (ex.: nosso restaurante favorito)" />
            <input type="text" id="placeAddress" class="extra-input" placeholder="Endere√ßo ou cidade (ex.: Curitiba, PR)" />
            <button class="btn btn-sim" id="placeAddBtn">Salvar lugar</button>
          </div>
          <ul id="placesList" class="extra-list"></ul>
        </div>
      </section>

      <!-- BUCKET LIST DO CASAL -->
      <section class="extra-section bucket-section tab-panel" data-tab-section="sonhos">
        <div class="panel extra-card">
          <h2>Nossa lista de sonhos ‚ú®</h2>
          <p class="small">
            Coisas que voc√™s querem fazer juntos: viagens, cursos, planos pra casa...
          </p>
          <div class="extra-form">
            <input type="text" id="bucketInput" class="extra-input" placeholder="Ex.: viajar pra praia tal, morar juntos, adotar um gatinho..." />
            <button class="btn btn-sim" id="bucketAddBtn">Adicionar √† lista</button>
          </div>
          <p class="small" id="bucketProgress">Nenhum sonho marcado ainda.</p>
          <ul id="bucketList" class="extra-list extra-list-check"></ul>
        </div>
      </section>

      <!-- POTE DO AMOR -->
      <section class="extra-section lovejar-section tab-panel" data-tab-section="pote">
        <div class="panel extra-card">
          <h2>Pote do amor üíå</h2>
          <p class="small">
            Guardem bilhetes do tipo ‚ÄúHoje eu te amo porque...‚Äù. D√° pra sortear um aleatoriamente.
          </p>
          <div class="extra-form">
            <textarea id="loveJarInput" class="extra-input extra-textarea" placeholder="Hoje eu te amo porque..."></textarea>
            <button class="btn btn-sim" id="loveJarAddBtn">Guardar bilhete</button>
          </div>
          <div class="lovejar-random">
            <button class="btn btn-nao" id="loveJarRandomBtn">Sortear bilhete aleat√≥rio</button>
            <p class="small" id="loveJarRandomText">Nenhum bilhete sorteado ainda.</p>
          </div>
          <details class="lovejar-details">
            <summary class="small">Ver todos os bilhetes</summary>
            <ul id="loveJarList" class="extra-list"></ul>
          </details>
        </div>
      </section>

      <!-- QUIZ DO CASAL -->
      <section class="extra-section quiz-section tab-panel" data-tab-section="quiz">
        <div class="panel extra-card">
          <h2>Quiz do casal ‚ùì</h2>
          <p class="small">
            Um joguinho simples sobre a hist√≥ria de voc√™s. Voc√™s podem brincar juntos.
          </p>
          <div id="quizContainer"></div>
          <p class="small" id="quizResult"></p>
        </div>
      </section>

      <!-- V√çDEOS & DEPOIMENTOS -->
      <section class="extra-section videos-section tab-panel" data-tab-section="videos">
        <div class="panel extra-card">
          <h2>V√≠deos & depoimentos üé¨</h2>
          <p class="small">
            Guardem links de v√≠deos especiais (YouTube, Drive, etc.) pra assistir quando der saudade.
          </p>
          <div class="extra-form">
            <input type="text" id="videoTitle" class="extra-input" placeholder="T√≠tulo do v√≠deo" />
            <input type="text" id="videoUrl" class="extra-input" placeholder="Link do v√≠deo (YouTube, Drive, etc.)" />
            <button class="btn btn-sim" id="videoAddBtn">Adicionar v√≠deo</button>
          </div>
          <ul id="videosList" class="extra-list extra-list-links"></ul>
        </div>
      </section>

      <!-- NOSSO CALEND√ÅRIO -->
      <section class="extra-section calendar-section tab-panel" data-tab-section="agenda">
        <div class="panel extra-card">
          <h2>Nosso calend√°rio ‚ù§Ô∏è</h2>
          <p class="small">
            Datas importantes, combinados e rol√™s marcados. Voc√™s podem usar isso como base pra adicionar no calend√°rio do celular.
          </p>
          <div class="extra-form calendar-form">
            <input type="date" id="eventDate" class="extra-input" />
            <input type="time" id="eventTime" class="extra-input" />
            <input type="text" id="eventTitle" class="extra-input" placeholder="Ex.: jantar especial, viagem, cinema..." />
            <button class="btn btn-sim" id="eventAddBtn">Salvar evento</button>
          </div>
          <ul id="eventsList" class="extra-list extra-list-events"></ul>
        </div>
      </section>

      <!-- HUMOR & GRAFICO -->
      <section class="extra-section mood-section tab-panel" data-tab-section="humor">
        <div class="panel extra-card">
          <h2>Hist√≥rico de humor do casal üìà</h2>
          <p class="small">
            Um gr√°fico simples usando os votos do ‚ÄúN√≠vel de satisfa√ß√£o com o moz√£o‚Äù. Os dados ficam salvos nesse navegador.
          </p>
          <canvas id="moodChart" width="400" height="220"></canvas>
          <p class="small" id="moodChartStatus"></p>
        </div>
      </section>

      <!-- INSPIRA√á√ïES & IDEIAS -->
      <section class="extra-section ideas-section tab-panel" data-tab-section="ideias">
        <div class="panel extra-card">
          <h2>Inspira√ß√µes & ideias ‚ú®</h2>
          <p class="small">
            Receitas, filmes, lugares pra visitar, ideias de presentes... tudo o que lembre voc√™s dois.
          </p>
          <div class="extra-form">
            <input type="text" id="ideaText" class="extra-input" placeholder="Ex.: maratonar tal s√©rie, cozinhar tal receita, visitar tal lugar..." />
            <button class="btn btn-sim" id="ideaAddBtn">Adicionar inspira√ß√£o</button>
          </div>
          <ul id="ideasList" class="extra-list"></ul>
        </div>
      </section>

      <!-- NOTIFICA√á√ïES -->
      <section class="extra-section notif-section tab-panel" data-tab-section="notif">
        <div class="panel extra-card">
          <h2>Lembretes & notifica√ß√µes üîî</h2>
          <p class="small">
            Aqui voc√™s podem testar as notifica√ß√µes do navegador para o site. Funciona melhor quando o site est√° em HTTPS (por exemplo, no dom√≠nio oficial).
          </p>
          <div class="extra-form">
            <button class="btn btn-sim" id="notifRequestBtn">Ativar/confirmar notifica√ß√µes</button>
            <button class="btn btn-nao" id="notifTestBtn">Enviar notifica√ß√£o de teste</button>
          </div>
          <p class="small" id="notifStatus">As notifica√ß√µes ainda n√£o foram configuradas.</p>
        </div>
      </section>

      <!-- M√öSICA -->
      <section class="music-wrapper tab-panel" data-tab-section="musica">
        <div class="panel music-card">
          <h2>M√∫sica do nosso amor üéµ</h2>
          <p class="music-sub">
            Voc√™s podem ouvir a m√∫sica que est√° salva no site, ou a playlist inteira no Spotify.
          </p>

          <div class="music-section music-spotify-embed">
            <h4>Playlist no Spotify (pr√©via)</h4>
            <p class="small">Essa vers√£o √© o player embutido com pr√©via, funciona sem login.</p>
            <iframe style="border-radius:12px"
              src="https://open.spotify.com/embed/playlist/3RitDlOniO6hRIQxmLWrMw?utm_source=generator"
              allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
              loading="lazy">
            </iframe>
          </div>

          <div class="music-section" id="spotifyPremiumBlock">
            <h4>Ouvir a playlist inteira (Spotify Premium)</h4>
            <p class="small">
              Se voc√™ ou a Ana entrarem com uma conta Premium, a playlist toca inteira aqui no site. üíö
            </p>
            <div class="music-spotify-controls">
              <button class="btn btn-sim" id="spotifyLoginBtn">Entrar com Spotify</button>
              <button class="btn btn-nao" id="spotifyPlayBtn">Tocar playlist aqui</button>
            </div>
            <p class="music-status" id="spotifyStatus">Ainda n√£o conectado ao Spotify.</p>

            <details class="music-log-details">
              <summary class="small">Ver detalhes t√©cnicos (log)</summary>
              <pre id="spotifyLog" class="music-log"></pre>
            </details>
          </div>
        </div>
      </section>

      <footer>
        Feito com ‚ô• por Pablo ‚Äî EU TE AMO SUPER HIPER MEGA.
      </footer>
    </div>
  </div>

  <!-- Overlay mensagem grande -->
  <div class="overlay" id="overlay">
    <div class="overlay-card">
      <h2 id="overlayTitle">Eu te amo, Ana Clara ‚ù§</h2>
      <p id="overlayText" class="small">Uma mensagem especial do Pablo.</p>
      <div style="margin-top:14px"><button class="btn btn-sim" id="closeOverlay">Fechar</button></div>
    </div>
  </div>

  <!-- Overlay da carta de pedido de casamento -->
  <div class="overlay" id="proposalOverlay">
    <div class="letter-card">
      <div class="ring-icon">üíç</div>
      <h2 class="letter-title">Minha Ana Clara, quer casar comigo?</h2>
      <div class="letter-body">
        <p>Amor, a gente briga, discorda, se enrola na vida... mas em todas as vers√µes da minha hist√≥ria, <strong>voc√™</strong> est√° l√°.</p>
        <p>Mesmo nos dias dif√≠ceis, √© com voc√™ que eu quero conversar, rir, dividir o caf√©, o cansa√ßo e os sonhos. Eu n√£o me imagino em um futuro em que voc√™ n√£o esteja do meu lado.</p>
        <p>Eu te amo de um jeito que n√£o cabe s√≥ em palavras, nem s√≥ num site cheio de cora√ß√µes caindo. Eu te amo no sil√™ncio, nos detalhes, nas piadas internas e at√© nas nossas teimosias.</p>
        <p>Por isso, com todo o amor e todo o medo e toda a coragem do mundo, eu quero te perguntar de verdade:</p>
        <p style="text-align:center; font-size:18px; margin-top:8px;"><strong>Voc√™ aceita viver pra sempre comigo?</strong></p>
        <p style="margin-top:10px;">Quero caminhar ao seu lado, construir uma casa que tenha a nossa cara, nossos cheiros, nossas manias e muitos gatinhos (ou peixinhos, quem sabe üêü). Quero envelhecer rindo das nossas hist√≥rias e lembrando de quando tudo come√ßou.</p>
        <p>Eu te amo, Ana Clara. Hoje, amanh√£ e depois. Para sempre seu,</p>
        <p><strong>Pablo üíñ</strong></p>
      </div>
      <div style="margin-top:16px; text-align:center;">
        <button class="btn btn-sim" id="closeProposal">Fechar essa carta (por enquanto)</button>
      </div>
    </div>
  </div>

  <!-- Overlay de galeria completa -->
  <div class="overlay" id="galleryOverlay">
    <div class="overlay-card">
      <h2 style="margin-top:0;">Todas as nossas fotos üíï</h2>
      <p class="small">Aqui aparece tudo, inclusive as que est√£o escondidas no "+N".</p>
      <div id="fullGallery"></div>
      <div style="margin-top:14px; text-align:right;">
        <button class="btn btn-nao" id="closeGalleryOverlay">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <!-- Spotify Web Playback SDK -->
  <script src="https://sdk.scdn.co/spotify-player.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDS1YA0FRvCIryjreFVzRMZyaHhYtm-pUU",
      authDomain: "euteamoanaclaraks.firebaseapp.com",
      databaseURL: "https://euteamoanaclaraks-default-rtdb.firebaseio.com",
      projectId: "euteamoanaclaraks",
      storageBucket: "euteamoanaclaraks.firebasestorage.app",
      messagingSenderId: "972847187116",
      appId: "1:972847187116:web:016a7b8a3dd7a688320b09",
      measurementId: "G-7LN9PKSCW3"
    };

    let db = null;
    try{
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      console.log("Firebase inicializado (Realtime DB).");
    }catch(e){
      console.warn("Firebase n√£o inicializou, mas o site continua funcionando.", e);
    }
    const coupleId = "pablo-ana";

    /* Cora√ß√µes de fundo */
    const heartsLayer = document.getElementById('heartsLayer');
    function spawnHeart(x){
      const el = document.createElement('span');
      el.className = 'heart';
      el.innerText = '‚ù§';
      const size = Math.random()*18 + 14;
      el.style.left = (x != null ? x : Math.random()*100) + 'vw';
      el.style.fontSize = size + 'px';
      const dur = Math.random()*5 + 5;
      el.style.animation = `fall ${dur}s linear forwards`;
      el.style.opacity = (Math.random()*0.4)+0.6;
      heartsLayer.appendChild(el);
      setTimeout(()=> el.remove(), (dur+0.6)*1000);
    }
    function initialRain(count=22){
      for(let i=0;i<count;i++){
        setTimeout(()=>spawnHeart(), i*120);
      }
    }
    initialRain(26);
    setInterval(()=>{ spawnHeart(Math.random()*100); }, 8000);

    /* Slider amor */
    const loveRange = document.getElementById('loveRange');
    const loveVal = document.getElementById('loveVal');
    loveRange.addEventListener('input', function(){
      const v = Number(this.value);
      loveVal.innerText = v;
      if(window._loveRevertTimeout) clearTimeout(window._loveRevertTimeout);
      if(v < 10){
        window._loveRevertTimeout = setTimeout(()=>{
          loveRange.value = 10;
          loveVal.innerText = 10;
          popupHeartsBurst();
          showTinyNote('Pra sempre 10/10 ‚ú®');
          window._loveRevertTimeout = null;
        }, 1000);
      } else {
        if(window._loveRevertTimeout){
          clearTimeout(window._loveRevertTimeout);
          window._loveRevertTimeout = null;
        }
      }
    });

    /* Perdoa Pablo */
    const btnSim = document.getElementById('btnSim');
    const btnNao = document.getElementById('btnNao');
    btnSim.onclick = ()=>{
      btnSim.innerText = 'SIM ‚ù§';
      btnNao.innerText = 'N√ÉO';
      popupHeartsBurst();
    };
    btnNao.onclick = ()=>{
      btnSim.innerText = 'SIM ‚ù§';
      btnNao.innerText = 'N√ÉO ‚ûú agora √© SIM';
      popupHeartsBurst();
      setTimeout(()=>{ btnNao.innerText = 'N√ÉO'; }, 900);
    };

    /* Galeria + carrossel com +N */
    const gallery = document.getElementById('gallery');
    const heroImg = document.getElementById('heroImg');
    const fullGallery = document.getElementById('fullGallery');
    const galleryOverlay = document.getElementById('galleryOverlay');
    const closeGalleryOverlay = document.getElementById('closeGalleryOverlay');

    let heroSources = [];
    let currentHeroIndex = 0;
    let heroTimer = null;

    let basePhotos = [
      'images/ana_e_eu_zoo.jpg',
      'images/us_beach.jpg',
      'images/us_zoo.jpg',
      'images/wedding.jpg'
    ];
    let dynamicPhotos = []; // {id, src}
    let allPhotos = [];     // base + dynamic

    function registerHeroSrc(src){
      if(!src) return;
      if(!heroSources.includes(src)){
        heroSources.push(src);
      }
    }

    function setHeroFromSrc(src, fromCarousel=false){
      if(!src) return;
      registerHeroSrc(src);
      const img = heroImg;
      img.classList.remove('fade-in');
      img.classList.add('fade-out');
      setTimeout(()=>{
        img.src = src;
        img.classList.remove('fade-out');
        img.classList.add('fade-in');
      }, 220);
      if(!fromCarousel){
        const idx = heroSources.indexOf(src);
        if(idx >= 0) currentHeroIndex = idx;
      }
    }

    function startHeroCarousel(){
      if(heroTimer) clearInterval(heroTimer);
      heroTimer = setInterval(()=>{
        if(heroSources.length <= 1) return;
        currentHeroIndex = (currentHeroIndex + 1) % heroSources.length;
        const nextSrc = heroSources[currentHeroIndex];
        setHeroFromSrc(nextSrc, true);
      }, 6000);
    }

    function rebuildAllPhotos(){
      allPhotos = [];
      basePhotos.forEach(src => allPhotos.push({id:null, src, dynamic:false}));
      dynamicPhotos.forEach(p => allPhotos.push({id:p.id, src:p.src, dynamic:true}));
      renderGallery();
      renderFullGallery();
    }

    function createThumbElement(photo, allowRemove){
      const wrap = document.createElement('div');
      wrap.className = 'thumb-wrapper';
      const img = document.createElement('img');
      img.src = photo.src;
      img.className = 'thumb';
      img.addEventListener('click', ()=> setHeroFromSrc(photo.src));
      wrap.appendChild(img);

      if(photo.dynamic && allowRemove && photo.id){
        const btn = document.createElement('button');
        btn.className = 'thumb-remove';
        btn.innerText = '√ó';
        btn.title = 'Remover esta foto';
        btn.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          if(!confirm('Tem certeza que quer remover esta foto da galeria?')) return;
          if(db){
            firebase.database().ref('gallery/' + coupleId + '/' + photo.id).remove()
              .then(()=>{
                showTinyNote('Foto removida üóëÔ∏è');
              })
              .catch(err=>{
                console.warn('Erro ao remover foto:', err);
                showTinyNote('N√£o consegui remover üò¢');
              });
          } else {
            // remove localmente
            dynamicPhotos = dynamicPhotos.filter(p => p.id !== photo.id);
            rebuildAllPhotos();
          }
        });
        wrap.appendChild(btn);
      }

      registerHeroSrc(photo.src);
      return wrap;
    }

    function renderGallery(){
      gallery.innerHTML = '';
      const maxVisible = 12;
      const visible = allPhotos.slice(0, maxVisible);
      visible.forEach(photo=>{
        gallery.appendChild(createThumbElement(photo, true));
      });
      const hiddenCount = allPhotos.length - visible.length;
      if(hiddenCount > 0){
        const extra = document.createElement('div');
        extra.className = 'thumb-extra';
        extra.innerText = '+' + hiddenCount;
        extra.title = 'Ver todas as fotos';
        extra.addEventListener('click', ()=>{
          galleryOverlay.classList.add('show');
        });
        gallery.appendChild(extra);
      }
    }

    function renderFullGallery(){
      fullGallery.innerHTML = '';
      allPhotos.forEach(photo=>{
        fullGallery.appendChild(createThumbElement(photo, true));
      });
    }

    closeGalleryOverlay.addEventListener('click', ()=>{
      galleryOverlay.classList.remove('show');
    });

    // Carrega fotos base
    basePhotos.forEach(src => registerHeroSrc(src));
    setHeroFromSrc(basePhotos[basePhotos.length-1]);
    startHeroCarousel();

    // Upload fotos -> Realtime DB
    const fileInput = document.getElementById('fileInput');
    const savePhotosBtn = document.getElementById('savePhotosBtn');

    savePhotosBtn.addEventListener('click', () => {
      const files = Array.from(fileInput.files || []);
      if(!files.length){
        alert('Escolha pelo menos uma foto primeiro üôÇ');
        return;
      }
      if(!db){
        showTinyNote('Firebase n√£o dispon√≠vel, n√£o consegui salvar üò¢');
        return;
      }
      files.forEach(file => {
        if(!file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = function(ev){
          const dataUrl = ev.target.result;
          firebase.database().ref('gallery/' + coupleId).push({
            dataUrl,
            name: file.name || null,
            createdAt: Date.now()
          }).then(()=>{
            showTinyNote('Foto salva na galeria üíñ');
          }).catch(err => {
            console.warn('Erro ao salvar foto:', err);
            showTinyNote('N√£o consegui salvar uma das fotos üò¢');
          });
        };
        reader.readAsDataURL(file);
      });
      fileInput.value = '';
    });

    if(db){
      firebase.database()
        .ref('gallery/' + coupleId)
        .orderByChild('createdAt')
        .limitToLast(60)
        .on('value', snapshot => {
          const data = snapshot.val();
          dynamicPhotos = [];
          if(data){
            const entries = Object.entries(data).sort((a,b)=>{
              const va = (a[1] && a[1].createdAt) || 0;
              const vb = (b[1] && b[1].createdAt) || 0;
              return va - vb;
            });
            entries.forEach(([id,item])=>{
              if(item && item.dataUrl){
                dynamicPhotos.push({id, src:item.dataUrl, dynamic:true});
              }
            });
          }
          rebuildAllPhotos();
        }, err => {
          console.warn('Erro ao ler galeria do Firebase:', err);
        });
    } else {
      rebuildAllPhotos();
    }

    /* Overlays mensagem e proposta */
    const overlay = document.getElementById('overlay');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlayText = document.getElementById('overlayText');
    const showMsg = document.getElementById('showMsg');
    const closeOverlay = document.getElementById('closeOverlay');
    showMsg.onclick = ()=>{
      overlayTitle.innerText = 'Ana Clara, eu te amo ‚ù§';
      overlayText.innerText = document.getElementById('loveMsg').value;
      overlay.classList.add('show');
      initialRain(40);
    };
    closeOverlay.onclick = ()=> overlay.classList.remove('show');

    const proposalBtn = document.getElementById('proposalBtn');
    const proposalOverlay = document.getElementById('proposalOverlay');
    const closeProposal = document.getElementById('closeProposal');
    proposalBtn.onclick = ()=>{
      proposalOverlay.classList.add('show');
      initialRain(35);
    };
    closeProposal.onclick = ()=> proposalOverlay.classList.remove('show');

    document.getElementById('surprise').onclick = ()=>{ initialRain(36); popupHeartsBurst(); };
    document.getElementById('popupLove').onclick = ()=>{ initialRain(30); popupHeartsBurst(); };

    function popupHeartsBurst(){
      const burst = document.createElement('div');
      burst.className='burst';
      document.body.appendChild(burst);
      for(let i=0;i<18;i++){
        const b = document.createElement('div');
        b.className='bheart';
        b.innerText='‚ù§';
        const angle = Math.random()*Math.PI*2;
        const radius = Math.random()*140+20;
        b.style.left = (50 + Math.cos(angle)*radius) + 'vw';
        b.style.top = (40 + Math.sin(angle)*radius) + 'vh';
        b.style.opacity = 1;
        b.style.transform = 'scale(0.9)';
        b.style.transition = 'transform 900ms cubic-bezier(.2,1,.3,1), opacity 900ms';
        burst.appendChild(b);
        setTimeout(()=>{
          b.style.transform='translateY(-40vh) scale(1.2)';
          b.style.opacity=0;
        }, 40+i*20);
      }
      setTimeout(()=> burst.remove(), 1200);
    }

    function popupEmojiBurst(emoji){
      const burst = document.createElement('div');
      burst.className='burst';
      document.body.appendChild(burst);
      for(let i=0;i<14;i++){
        const b = document.createElement('div');
        b.className='bheart';
        b.innerText=emoji;
        const angle = Math.random()*Math.PI*2;
        const radius = Math.random()*140+20;
        b.style.left = (50 + Math.cos(angle)*radius) + 'vw';
        b.style.top = (45 + Math.sin(angle)*radius) + 'vh';
        b.style.opacity = 1;
        b.style.transform = 'scale(0.9)';
        b.style.transition = 'transform 900ms cubic-bezier(.2,1,.3,1), opacity 900ms';
        burst.appendChild(b);
        setTimeout(()=>{
          b.style.transform='translateY(-40vh) scale(1.2)';
          b.style.opacity=0;
        }, 40+i*20);
      }
      setTimeout(()=> burst.remove(), 1200);
    }

    function iceRain(){
      const container = document.createElement('div');
      container.className = 'burst';
      document.body.appendChild(container);
      for(let i=0;i<18;i++){
        const ice = document.createElement('div');
        ice.className = 'bheart';
        ice.innerText = 'üßä';
        const startX = Math.random()*100;
        ice.style.left = startX + 'vw';
        ice.style.top = '-10vh';
        ice.style.opacity = 1;
        ice.style.transform = 'scale(1)';
        ice.style.transition = 'transform 1300ms ease-out, top 1300ms linear, opacity 1300ms ease-out';
        container.appendChild(ice);
        setTimeout(()=>{
          ice.style.top = '100vh';
          ice.style.transform = 'scale(0.4)';
          ice.style.opacity = 0;
        }, 30 + i*35);
      }
      setTimeout(()=> container.remove(), 1500);
    }

    function showTinyNote(text){
      const t = document.createElement('div');
      t.style.position='fixed';
      t.style.right='18px';
      t.style.bottom='18px';
      t.style.padding='10px 14px';
      t.style.background='linear-gradient(90deg,#ff9fc9,#ff4da6)';
      t.style.color='white';
      t.style.borderRadius='12px';
      t.style.boxShadow='0 6px 20px rgba(0,0,0,0.18)';
      t.style.zIndex=999;
      t.innerText=text;
      document.body.appendChild(t);
      setTimeout(()=> t.style.opacity=0, 1600);
      setTimeout(()=> t.remove(), 2100);
    }

    /* Contagem regressiva 19/11/2025 18h */
    (function(){
      var countdownTimeEl = document.getElementById('countdownTime');
      var countdownMsgEl  = document.getElementById('countdownMsg');
      if(!countdownTimeEl || !countdownMsgEl) return;
      var targetDate = new Date(2025, 10, 19, 18, 0, 0); // m√™s 10 = novembro

      function pad2(n){ return (n<10?'0':'') + n; }

      function updateCountdown(){
        var now  = new Date();
        var diff = targetDate.getTime() - now.getTime();
        if(diff <= 0){
          countdownTimeEl.innerHTML =
            '<span>00d</span> <span>00h</span> <span>00m</span> <span>00s</span>';
          countdownMsgEl.textContent =
            'J√° √© o dia do encontro! Espero que voc√™s estejam juntinhos agora üíñ';
          return;
        }
        var totalSeconds = Math.floor(diff / 1000);
        var days    = Math.floor(totalSeconds / 86400);
        var hours   = Math.floor((totalSeconds % 86400) / 3600);
        var minutes = Math.floor((totalSeconds % 3600) / 60);
        var seconds = totalSeconds % 60;

        var htmlTime =
          '<span>' + pad2(days)    + 'd</span> ' +
          '<span>' + pad2(hours)   + 'h</span> ' +
          '<span>' + pad2(minutes) + 'm</span> ' +
          '<span>' + pad2(seconds) + 's</span>';
        countdownTimeEl.innerHTML = htmlTime;

        var msg;
        if(days > 1){
          msg = 'Faltam ' + days + ' dias pro pr√≥ximo encontro. Aguenta cora√ß√£ozinho üíò';
        }else if(days === 1){
          msg = 'Falta 1 dia pro encontro! J√° pode come√ßar a surtar de ansiedade ü•π';
        }else{
          msg = '√â hoje! Daqui a pouquinho voc√™s v√£o se abra√ßar üíû';
        }
        countdownMsgEl.textContent = msg;
      }
      updateCountdown();
      setInterval(updateCountdown, 1000);
    })();

    /* Painel de satisfa√ß√£o */
    const satButtons = document.querySelectorAll('.sat-user-btn');
    const satCurrentUserLabel = document.getElementById('satCurrentUser');
    const satRows = document.querySelectorAll('.sat-row');
    const markerPablo = document.querySelector('.sat-marker-pablo');
    const markerAna   = document.querySelector('.sat-marker-ana');
    const satCard = document.querySelector('.satisfaction-card');

    const levelEmoji = {
      perfect: 'üíò',
      good: '‚≠ê',
      chill: 'üòé',
      ice: 'üßä',
      jail: '‚õìÔ∏è'
    };

    let currentUser = localStorage.getItem('satCurrentUser') || null;
    const jailExtra = document.getElementById('jailExtra');
    const jailLabel = document.getElementById('jailLabel');
    const jailText = document.getElementById('jailText');
    const jailSaveBtn = document.getElementById('jailSaveBtn');
    let jailStatus = {pablo:false, ana:false};
    let jailFor = null;

    function updateCurrentUserUI(){
      satButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.user === currentUser);
      });
      satCurrentUserLabel.textContent = currentUser ?
        (currentUser === 'pablo' ? 'Pablo (namorado)' : 'Ana Clara (namorada)') :
        'ningu√©m';
    }

    satButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        currentUser = btn.dataset.user;
        localStorage.setItem('satCurrentUser', currentUser);
        updateCurrentUserUI();
      });
    });
    updateCurrentUserUI();

    const levelMap = {};
    satRows.forEach(row => {
      levelMap[row.dataset.level] = row;
      row.addEventListener('click', () => {
        if(!currentUser){
          alert('Escolhe se voc√™ √© o Pablo ou a Ana primeiro üòâ');
          return;
        }
        const levelKey = row.dataset.level;
        const targetUser = currentUser === 'pablo' ? 'ana' : 'pablo';
        placeMarker(targetUser, levelKey);
        localStorage.setItem('satLevel_' + targetUser, levelKey);

        if(levelKey === 'perfect'){
          initialRain(24);
          popupHeartsBurst();
          popupEmojiBurst('üíò');
          popupEmojiBurst('üî•');
          showTinyNote((targetUser === 'pablo' ? 'Pablo' : 'Ana') + ' √© amorzinho perfeito(a)!');
        } else if(levelKey === 'good'){
          popupEmojiBurst('‚≠ê');
          showTinyNote((targetUser === 'pablo' ? 'Pablo' : 'Ana') + ' est√° muito bonzinho(a) ‚≠ê');
        } else if(levelKey === 'chill'){
          popupEmojiBurst('üòé');
          showTinyNote((targetUser === 'pablo' ? 'Pablo' : 'Ana') + ' est√° de boa / chill üòé');
        } else if(levelKey === 'ice'){
          iceRain();
          showTinyNote((targetUser === 'pablo' ? 'Pablo' : 'Ana') + ' est√° em gelo fino üßä');
        } else if(levelKey === 'jail'){
          showJailAnimation(targetUser);
          popupEmojiBurst('‚õìÔ∏è');
          showTinyNote((targetUser === 'pablo' ? 'Pablo' : 'Ana') + ' foi pra cadeia üò¨');
        }

        if(db){
          firebase.database().ref('satisfaction/' + coupleId + '/' + targetUser).set(levelKey)
            .catch(err => console.warn('Erro ao salvar no Firebase:', err));
        }
      });
    });

    function placeMarker(user, levelKey){
      const row = levelMap[levelKey];
      if(!row) return;
      const container = row.querySelector('.sat-markers');
      const emoji = levelEmoji[levelKey] || '‚ù§';
      const marker = (user === 'pablo') ? markerPablo : markerAna;
      const letra = (user === 'pablo') ? 'P ' : 'A ';
      marker.textContent = letra + emoji;
      container.appendChild(marker);

      jailStatus[user] = (levelKey === 'jail');
      updateJailUIFromStatus();
    }

    function updateJailUIFromStatus(){
      const someone = jailStatus.pablo ? 'pablo' : (jailStatus.ana ? 'ana' : null);
      jailFor = someone;
      if(!jailFor){
        jailExtra.style.display = 'none';
        return;
      }
      jailExtra.style.display = 'block';
      const alvoNome = jailFor === 'pablo' ? 'Pablo' : 'Ana';
      jailLabel.textContent = `O que o ${alvoNome} pode fazer para sair da cadeia?`;
      const noteKey = 'jailNote_' + jailFor;
      const note = localStorage.getItem(noteKey) || '';
      jailText.value = note;
    }

    function showJailAnimation(){
      if(!satCard) return;
      const wrap = document.createElement('div');
      wrap.className = 'jail-anim';
      const bars = document.createElement('div');
      bars.className = 'jail-bars';
      for(let i=0;i<5;i++){
        const s = document.createElement('span');
        bars.appendChild(s);
      }
      wrap.appendChild(bars);
      satCard.appendChild(wrap);
      setTimeout(()=>{ wrap.style.opacity='0'; }, 900);
      setTimeout(()=> wrap.remove(), 1300);
    }

    jailSaveBtn.addEventListener('click', () => {
      if(!jailFor){
        alert('Ningu√©m est√° na cadeia agora üòÇ');
        return;
      }
      const text = jailText.value.trim();
      const key = 'jailNote_' + jailFor;
      localStorage.setItem(key, text);
      if(db){
        firebase.database().ref('satisfaction/' + coupleId + '/note_' + jailFor).set(text)
          .catch(err => console.warn('Erro ao salvar nota da cadeia:', err));
      }
      showTinyNote('Plano para sair da cadeia salvo üìù');
    });

    const localPablo = localStorage.getItem('satLevel_pablo');
    const localAna = localStorage.getItem('satLevel_ana');
    if(localPablo) placeMarker('pablo', localPablo);
    if(localAna)   placeMarker('ana', localAna);

    if(db){
      firebase.database().ref('satisfaction/' + coupleId).on('value', snapshot => {
        const data = snapshot.val() || {};
        if(data.pablo){
          localStorage.setItem('satLevel_pablo', data.pablo);
          placeMarker('pablo', data.pablo);
        }
        if(data.ana){
          localStorage.setItem('satLevel_ana', data.ana);
          placeMarker('ana', data.ana);
        }
        if(data.note_pablo){
          localStorage.setItem('jailNote_pablo', data.note_pablo);
          if(jailFor === 'pablo') jailText.value = data.note_pablo;
        }
        if(data.note_ana){
          localStorage.setItem('jailNote_ana', data.note_ana);
          if(jailFor === 'ana') jailText.value = data.note_ana;
        }
      });
    }

    /* ENQUETE "SEXO HOJE" */
    const pollSexoBtns = document.querySelectorAll('.poll-btn[data-poll="sexo"]');
    const pollSexoStatus = document.getElementById('pollSexoStatus');

    function setSexoUI(choice){
      pollSexoBtns.forEach(btn => {
        btn.classList.toggle('selected', btn.getAttribute('data-value') === choice);
      });
      if(choice === 'sim'){
        pollSexoStatus.textContent = '√öltima resposta: Sim üòà';
      }else if(choice === 'nao'){
        pollSexoStatus.textContent = '√öltima resposta: N√£o üôÖ‚Äç‚ôÄÔ∏è';
      }else{
        pollSexoStatus.textContent = 'Ainda sem resposta hoje.';
      }
    }

    pollSexoBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const choice = btn.getAttribute('data-value');
        setSexoUI(choice);
        if(db){
          firebase.database().ref('polls/' + coupleId + '/sexoHoje').set({
            value: choice,
            updatedAt: Date.now()
          }).catch(err => console.warn('Erro ao salvar enquete sexoHoje:', err));
        }
      });
    });

    if(db){
      firebase.database().ref('polls/' + coupleId + '/sexoHoje').on('value', snap => {
        const data = snap.val();
        if(!data || !data.value){
          setSexoUI(null);
          return;
        }
        setSexoUI(data.value);
      });
    }

    /* CARD√ÅPIO DO DIA */
    const menuInput  = document.getElementById('menuInput');
    const menuSaveBtn = document.getElementById('menuSaveBtn');
    const menuStatus = document.getElementById('menuStatus');

    menuSaveBtn.addEventListener('click', () => {
      const text = (menuInput.value || '').trim();
      if(!text){
        alert('Escreve alguma coisa pro card√°pio üòã');
        return;
      }
      if(db){
        firebase.database().ref('polls/' + coupleId + '/cardapioHoje').set({
          text,
          updatedAt: Date.now()
        }).then(() => {
          showTinyNote('Card√°pio atualizado üçΩÔ∏è');
        }).catch(err => console.warn('Erro ao salvar card√°pio:', err));
      }else{
        menuStatus.textContent = 'Sugest√£o atual: ' + text;
      }
    });

    if(db){
      firebase.database().ref('polls/' + coupleId + '/cardapioHoje').on('value', snap => {
        const data = snap.val();
        if(!data || !data.text){
          menuStatus.textContent = 'Sem sugest√£o ainda. Escrevam algo gostoso pra hoje üòã';
          return;
        }
        menuInput.value = data.text;
        menuStatus.textContent = 'Sugest√£o atual: ' + data.text;
      });
    }

    /* MURAL DE RECADOS */
    const muralText = document.getElementById('muralText');
    const muralIsTask = document.getElementById('muralIsTask');
    const muralAddBtn = document.getElementById('muralAddBtn');
    const muralList = document.getElementById('muralList');

    function renderMural(items){
      muralList.innerHTML = '';
      items.forEach(([id, item])=>{
        if(!item || !item.text) return;
        const li = document.createElement('li');
        li.className = 'mural-item' + (item.isTask ? ' mural-task' : '');
        li.dataset.id = id;

        const wrap = document.createElement('div');
        wrap.className = 'mural-text-wrap';

        const p = document.createElement('p');
        p.className = 'mural-text';
        p.textContent = item.text;
        if(item.isTask && item.done){
          p.classList.add('done');
        }
        wrap.appendChild(p);

        const meta = document.createElement('div');
        meta.className = 'mural-meta';
        const date = item.createdAt ? new Date(item.createdAt) : null;
        meta.textContent = (item.isTask ? 'Miss√£o' : 'Recado') +
          (date ? ' ‚Ä¢ ' + date.toLocaleString('pt-BR',{dateStyle:'short', timeStyle:'short'}) : '');
        wrap.appendChild(meta);

        li.appendChild(wrap);

        const actions = document.createElement('div');
        actions.className = 'mural-actions';

        if(item.isTask){
          const btnDone = document.createElement('button');
          btnDone.className = 'btn-mini btn-mini-primary';
          btnDone.textContent = item.done ? 'Desmarcar' : 'Feito';
          btnDone.addEventListener('click', ()=>{
            if(db){
              firebase.database().ref('mural/' + coupleId + '/' + id + '/done').set(!item.done);
            }
          });
          actions.appendChild(btnDone);
        }

        const btnDelete = document.createElement('button');
        btnDelete.className = 'btn-mini btn-mini-danger';
        btnDelete.textContent = 'Apagar';
        btnDelete.addEventListener('click', ()=>{
          if(!confirm('Apagar este recadinho?')) return;
          if(db){
            firebase.database().ref('mural/' + coupleId + '/' + id).remove();
          }else{
            li.remove();
          }
        });
        actions.appendChild(btnDelete);

        li.appendChild(actions);
        muralList.appendChild(li);
      });
    }

    muralAddBtn.addEventListener('click', ()=>{
      const text = (muralText.value || '').trim();
      const isTask = muralIsTask.checked;
      if(!text){
        alert('Escreve alguma coisa antes de adicionar o recado üòä');
        return;
      }
      const data = {
        text,
        isTask,
        done:false,
        createdAt: Date.now()
      };
      if(db){
        firebase.database().ref('mural/' + coupleId).push(data)
          .then(()=> showTinyNote('Recado adicionado no mural üíå'))
          .catch(err=> console.warn('Erro ao salvar recado:', err));
      }
      muralText.value = '';
      muralIsTask.checked = false;
    });

    if(db){
      firebase.database().ref('mural/' + coupleId).on('value', snap=>{
        const data = snap.val() || {};
        const entries = Object.entries(data).sort((a,b)=>{
          const va = (a[1] && a[1].createdAt) || 0;
          const vb = (b[1] && b[1].createdAt) || 0;
          return va - vb;
        });
        renderMural(entries);
      });
    }

    /* SPOTIFY WEB PLAYBACK (implicit grant) */
    const SPOTIFY_CLIENT_ID = 'd87db58ea9434615bb2c2603e7ff4326';
    const SPOTIFY_REDIRECT_URI = window.location.origin + window.location.pathname;
    const SPOTIFY_PLAYLIST_URI = 'spotify:playlist:3RitDlOniO6hRIQxmLWrMw';

    // Detec√ß√£o simples de mobile (pra limitar o player Premium ao desktop)
    const isMobile = /Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent || '');

    const spotifyLoginBtn = document.getElementById('spotifyLoginBtn');
    const spotifyPlayBtn  = document.getElementById('spotifyPlayBtn');
    const spotifyStatusEl = document.getElementById('spotifyStatus');
    const spotifyLogEl    = document.getElementById('spotifyLog');

    function logSpotify(msg){
      if(!spotifyLogEl) return;
      const now = new Date().toLocaleTimeString('pt-BR',{hour12:false});
      spotifyLogEl.textContent += '[' + now + '] ' + msg + '\n';
      spotifyLogEl.scrollTop = spotifyLogEl.scrollHeight;
      console.log('[Spotify]', msg);
    }

    function updateSpotifyStatus(text){
      if(spotifyStatusEl){
        spotifyStatusEl.textContent = text;
      }
      logSpotify(text);
    }

    function getStoredSpotifyToken(){
      const raw = localStorage.getItem('spotifyAuth');
      if(!raw) return null;
      try{
        const data = JSON.parse(raw);
        if(!data.access_token || !data.expires_at) return null;
        if(Date.now() > data.expires_at){
          logSpotify('Token expirado, removendo.');
          localStorage.removeItem('spotifyAuth');
          return null;
        }
        return data.access_token;
      }catch(e){
        console.warn('Erro ao ler token Spotify:', e);
        return null;
      }
    }

    function storeSpotifyToken(accessToken, expiresInSec){
      const expiresAt = Date.now() + (expiresInSec*1000 - 60000);
      const payload = {access_token: accessToken, expires_at: expiresAt};
      localStorage.setItem('spotifyAuth', JSON.stringify(payload));
      logSpotify('Token Spotify salvo com sucesso.');
    }

    function parseTokenFromHash(){
      if(!window.location.hash || window.location.hash.indexOf('access_token=') === -1){
        return null;
      }
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const accessToken = params.get('access_token');
      const tokenType   = params.get('token_type');
      const expiresIn   = parseInt(params.get('expires_in') || '3600', 10);
      if(!accessToken) return null;
      window.history.replaceState(null, '', window.location.pathname + window.location.search);
      logSpotify('Token recebido via fragmento (implicit grant).');
      storeSpotifyToken(accessToken, expiresIn);
      return accessToken;
    }

    function ensureSpotifyToken(){
      let token = getStoredSpotifyToken();
      if(token){
        updateSpotifyStatus('Conectado ao Spotify ‚úÖ');
        return token;
      }
      token = parseTokenFromHash();
      if(token){
        updateSpotifyStatus('Conectado ao Spotify ‚úÖ');
        return token;
      }
      return null;
    }

    function startSpotifyLogin(){
      const scopes = [
        'streaming',
        'user-read-email',
        'user-read-private',
        'user-modify-playback-state'
      ];
      const authUrl = 'https://accounts.spotify.com/authorize?' +
        new URLSearchParams({
          client_id: SPOTIFY_CLIENT_ID,
          response_type: 'token',
          redirect_uri: SPOTIFY_REDIRECT_URI,
          scope: scopes.join(' '),
          show_dialog: 'true'
        }).toString();
      logSpotify('Redirecionando para login Spotify...');
      window.location.href = authUrl;
    }

    let spotifyPlayer = null;
    let spotifyDeviceId = null;
    let spotifySDKReady = false;
    let spotifyPlayerReady = false;

    window.onSpotifyWebPlaybackSDKReady = () => {
      spotifySDKReady = true;
      logSpotify('Spotify Web Playback SDK pronto.');
      const token = ensureSpotifyToken();
      if(token){
        createSpotifyPlayer(token);
      }else{
        updateSpotifyStatus('Clique em "Entrar com Spotify" para conectar sua conta.');
      }
    };

    function createSpotifyPlayer(token){
      if(!window.Spotify || !spotifySDKReady){
        logSpotify('SDK Spotify ainda n√£o est√° dispon√≠vel.');
        return;
      }
      if(spotifyPlayer){
        spotifyPlayer.disconnect();
      }
      spotifyPlayer = new Spotify.Player({
        name: 'Player do Pablo & Ana Clara üíñ',
        getOAuthToken: cb => { cb(token); },
        volume: 0.8
      });

      spotifyPlayer.addListener('ready', ({ device_id }) => {
        spotifyDeviceId = device_id;
        spotifyPlayerReady = true;
        updateSpotifyStatus('Player conectado! Device ID: ' + device_id);
      });

      spotifyPlayer.addListener('not_ready', ({ device_id }) => {
        spotifyDeviceId = null;
        spotifyPlayerReady = false;
        updateSpotifyStatus('Player Spotify n√£o est√° pronto (device ' + device_id + ').');
      });

      spotifyPlayer.addListener('initialization_error', ({ message }) => {
        logSpotify('Erro de inicializa√ß√£o: ' + message);
      });
      spotifyPlayer.addListener('authentication_error', ({ message }) => {
        logSpotify('Erro de autentica√ß√£o: ' + message);
        localStorage.removeItem('spotifyAuth');
        updateSpotifyStatus('Problema na autentica√ß√£o. Tente fazer login de novo.');
      });
      spotifyPlayer.addListener('account_error', ({ message }) => {
        logSpotify('Erro de conta: ' + message);
        updateSpotifyStatus('Sua conta precisa ser Premium pra tocar aqui üíö');
      });
      spotifyPlayer.addListener('playback_error', ({ message }) => {
        logSpotify('Erro de reprodu√ß√£o: ' + message);
      });

      spotifyPlayer.connect().then(success => {
        if(success){
          logSpotify('Conex√£o com player solicitada.');
        }else{
          logSpotify('N√£o consegui conectar o player.');
        }
      });
    }

    if(!isMobile){
      spotifyLoginBtn && spotifyLoginBtn.addEventListener('click', ()=>{
        startSpotifyLogin();
      });

      spotifyPlayBtn && spotifyPlayBtn.addEventListener('click', async ()=>{
        const token = ensureSpotifyToken();
        if(!token){
          alert('Antes clique em "Entrar com Spotify" pra fazer login. üíö');
          return;
        }
        if(!spotifyPlayer || !spotifySDKReady){
          logSpotify('Criando player Spotify...');
          createSpotifyPlayer(token);
          setTimeout(()=> playSpotifyPlaylist(token), 1800);
        }else{
          playSpotifyPlaylist(token);
        }
      });
    }else{
      // No celular, esconder os bot√µes do player Premium e mostrar uma mensagem amig√°vel
      if(spotifyLoginBtn) spotifyLoginBtn.style.display = 'none';
      if(spotifyPlayBtn) spotifyPlayBtn.style.display  = 'none';
      const logDetails = document.querySelector('.music-log-details');
      if(logDetails) logDetails.style.display = 'none';
      if(spotifyStatusEl){
        spotifyStatusEl.textContent = 'No celular, use a m√∫sica do site ou o player de pr√©via/Spotify app üíö. No computador, d√° pra entrar com Spotify Premium e ouvir tudo aqui.';
      }
    }

    async function playSpotifyPlaylist(token){
      if(!spotifyDeviceId){
        updateSpotifyStatus('Player ainda n√£o pronto, tentando conectar...');
        return;
      }
      try{
        updateSpotifyStatus('Enviando comando pra tocar a playlist...');
        const resp = await fetch('https://api.spotify.com/v1/me/player/play?device_id=' + encodeURIComponent(spotifyDeviceId), {
          method: 'PUT',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            context_uri: SPOTIFY_PLAYLIST_URI,
            offset: { position: 0 }
          })
        });
        if(resp.status === 204){
          updateSpotifyStatus('Playlist tocando! Se n√£o ouvir, abre o app do Spotify e escolhe o player "Pablo & Ana Clara".');
        }else{
          const txt = await resp.text();
          logSpotify('Resposta diferente de 204: ' + resp.status + ' ' + txt);
          updateSpotifyStatus('Tente abrir o app do Spotify e ver se o dispositivo aparece.');
        }
      }catch(e){
        logSpotify('Erro ao chamar /play: ' + e);
        updateSpotifyStatus('Deu algum erro ao mandar tocar üò¢');
      }
    }

    // Ao carregar a p√°gina:
    // - no desktop: tenta recuperar token do Spotify pra j√° mostrar conectado
    // - no celular: s√≥ mant√©m a mensagem de uso via app/preview
    document.addEventListener('DOMContentLoaded', ()=>{
      if(isMobile){
        if(spotifyStatusEl && !spotifyStatusEl.textContent){
          spotifyStatusEl.textContent = 'No celular, use a m√∫sica do site ou o player de pr√©via/Spotify app üíö.';
        }
        return;
      }
      const token = ensureSpotifyToken();
      if(token){
        updateSpotifyStatus('Conectado ao Spotify ‚úÖ (cliquem em "Tocar playlist aqui")');
      }
    });
  
    
    // =======================
    // Se√ß√µes extras do casal
    // =======================
    (function(){
      const LS_PREFIX = 'acLove_';

      function saveLS(key, value){
        try{
          localStorage.setItem(LS_PREFIX + key, JSON.stringify(value));
        }catch(e){}
      }
      function loadLS(key, def){
        try{
          const raw = localStorage.getItem(LS_PREFIX + key);
          if(!raw) return def;
          return JSON.parse(raw);
        }catch(e){
          return def;
        }
      }
      function uid(){
        return Date.now().toString(36) + Math.random().toString(36).slice(2);
      }

      function hasFirebase(){
        try{
          return typeof db !== 'undefined' && !!db && typeof coupleId !== 'undefined';
        }catch(e){
          return false;
        }
      }
      function syncToFirebase(sectionKey, data){
        if(!hasFirebase()) return;
        try{
          db.ref('extras/' + coupleId + '/' + sectionKey).set(data);
        }catch(e){
          console.warn('Erro ao salvar se√ß√£o extra no Firebase:', sectionKey, e);
        }
      }
      function listenFromFirebase(sectionKey, setter){
        if(!hasFirebase()) return;
        try{
          db.ref('extras/' + coupleId + '/' + sectionKey).on('value', function(snap){
            const val = snap.val();
            let arr;
            if(val == null){
              arr = [];
            }else if(Array.isArray(val)){
              arr = val;
            }else if(typeof val === 'object'){
              arr = Object.values(val);
            }else{
              arr = [];
            }
            setter(arr);
          });
        }catch(e){
          console.warn('Erro ao ler se√ß√£o extra do Firebase:', sectionKey, e);
        }
      }

      // ---- Linha do tempo ----
      const tlDate = document.getElementById('timelineDate');
      const tlTitle = document.getElementById('timelineTitle');
      const tlDesc = document.getElementById('timelineDesc');
      const tlBtn = document.getElementById('timelineAddBtn');
      const tlList = document.getElementById('timelineList');
      let tlData = loadLS('timeline', []);

      function setTimelineData(arr){
        tlData = Array.isArray(arr) ? arr : [];
        saveLS('timeline', tlData);
        renderTimeline();
      }
      function renderTimeline(){
        if(!tlList) return;
        tlList.innerHTML = '';
        const sorted = [].concat(tlData).sort(function(a,b){
          return (a.date || '').localeCompare(b.date || '');
        });
        sorted.forEach(function(item){
          const li = document.createElement('li');
          const title = document.createElement('div');
          title.textContent = (item.date || '') + (item.title ? ' ‚Äî ' + item.title : '');
          const desc = document.createElement('div');
          desc.textContent = item.desc || '';
          desc.className = 'extra-meta';
          li.appendChild(title);
          if(item.desc){
            li.appendChild(desc);
          }
          tlList.appendChild(li);
        });
      }
      if(tlBtn && tlList){
        tlBtn.addEventListener('click', function(){
          const d = tlDate.value || '';
          const t = (tlTitle.value || '').trim();
          const desc = (tlDesc.value || '').trim();
          if(!d && !t && !desc) return;
          tlData.push({id:uid(), date:d, title:t, desc:desc});
          saveLS('timeline', tlData);
          syncToFirebase('timeline', tlData);
          tlTitle.value = '';
          tlDesc.value = '';
          renderTimeline();
        });
        renderTimeline();
        listenFromFirebase('timeline', setTimelineData);
      }

      // ---- Lugares especiais ----
      const plName = document.getElementById('placeName');
      const plAddr = document.getElementById('placeAddress');
      const plBtn = document.getElementById('placeAddBtn');
      const plList = document.getElementById('placesList');
      let plData = loadLS('places', []);

      function setPlacesData(arr){
        plData = Array.isArray(arr) ? arr : [];
        saveLS('places', plData);
        renderPlaces();
      }
      function renderPlaces(){
        if(!plList) return;
        plList.innerHTML = '';
        plData.forEach(function(item){
          const li = document.createElement('li');
          const title = document.createElement('div');
          title.textContent = item.name || item.address || 'Lugar';
          const meta = document.createElement('div');
          meta.className = 'extra-meta';
          meta.textContent = item.address || '';
          const a = document.createElement('a');
          a.href = item.mapUrl;
          a.target = '_blank';
          a.rel = 'noopener';
          a.textContent = 'Abrir no mapa';
          li.appendChild(title);
          if(item.address){
            li.appendChild(meta);
          }
          li.appendChild(a);
          plList.appendChild(li);
        });
      }
      if(plBtn && plList){
        plBtn.addEventListener('click', function(){
          const name = (plName.value || '').trim();
          const address = (plAddr.value || '').trim();
          if(!name && !address) return;
          const query = address || name;
          const mapUrl = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(query);
          plData.push({id:uid(), name:name, address:address, mapUrl:mapUrl});
          saveLS('places', plData);
          syncToFirebase('places', plData);
          plName.value = '';
          plAddr.value = '';
          renderPlaces();
        });
        renderPlaces();
        listenFromFirebase('places', setPlacesData);
      }

      // ---- Bucket list ----
      const bkInput = document.getElementById('bucketInput');
      const bkBtn = document.getElementById('bucketAddBtn');
      const bkList = document.getElementById('bucketList');
      const bkProgress = document.getElementById('bucketProgress');
      let bkData = loadLS('bucket', []);

      function setBucketData(arr){
        bkData = Array.isArray(arr) ? arr : [];
        saveLS('bucket', bkData);
        renderBucket();
      }
      function updateBucketProgress(){
        if(!bkProgress) return;
        const total = bkData.length;
        const done = bkData.filter(function(i){return i.done;}).length;
        if(!total){
          bkProgress.textContent = 'Nenhum sonho marcado ainda.';
        }else{
          const pct = Math.round((done/total)*100);
          bkProgress.textContent = done + ' de ' + total + ' sonhos conclu√≠dos (' + pct + '%).';
        }
      }
      function renderBucket(){
        if(!bkList) return;
        bkList.innerHTML = '';
        bkData.forEach(function(item){
          const li = document.createElement('li');
          const label = document.createElement('label');
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = !!item.done;
          cb.addEventListener('change', function(){
            item.done = cb.checked;
            saveLS('bucket', bkData);
            syncToFirebase('bucket', bkData);
            updateBucketProgress();
          });
          const text = document.createElement('span');
          text.textContent = item.text;
          label.appendChild(cb);
          label.appendChild(text);
          li.appendChild(label);
          bkList.appendChild(li);
        });
        updateBucketProgress();
      }
      if(bkBtn && bkList){
        bkBtn.addEventListener('click', function(){
          const txt = (bkInput.value || '').trim();
          if(!txt) return;
          bkData.push({id:uid(), text:txt, done:false});
          saveLS('bucket', bkData);
          syncToFirebase('bucket', bkData);
          bkInput.value = '';
          renderBucket();
        });
        renderBucket();
        listenFromFirebase('bucket', setBucketData);
      }

      // ---- Pote do amor ----
      const ljInput = document.getElementById('loveJarInput');
      const ljAddBtn = document.getElementById('loveJarAddBtn');
      const ljRandomBtn = document.getElementById('loveJarRandomBtn');
      const ljRandomText = document.getElementById('loveJarRandomText');
      const ljList = document.getElementById('loveJarList');
      let ljData = loadLS('loveJar', []);

      function setLoveJarData(arr){
        ljData = Array.isArray(arr) ? arr : [];
        saveLS('loveJar', ljData);
        renderLoveJar();
      }
      function renderLoveJar(){
        if(!ljList) return;
        ljList.innerHTML = '';
        ljData.forEach(function(item){
          const li = document.createElement('li');
          const txt = document.createElement('div');
          txt.textContent = item.text;
          const meta = document.createElement('div');
          meta.className = 'extra-meta';
          meta.textContent = item.date || '';
          li.appendChild(txt);
          if(item.date){
            li.appendChild(meta);
          }
          ljList.appendChild(li);
        });
      }
      function randomLoveNote(){
        if(!ljData.length){
          if(ljRandomText) ljRandomText.textContent = 'Ainda n√£o tem nenhum bilhete salvo.';
          return;
        }
        const item = ljData[Math.floor(Math.random()*ljData.length)];
        if(ljRandomText){
          ljRandomText.textContent = item.text + (item.date ? ' (' + item.date + ')' : '');
        }
      }
      if(ljAddBtn){
        ljAddBtn.addEventListener('click', function(){
          const txt = (ljInput.value || '').trim();
          if(!txt) return;
          const today = new Date();
          const dateStr = today.toLocaleDateString('pt-BR');
          ljData.push({id:uid(), text:txt, date:dateStr});
          saveLS('loveJar', ljData);
          syncToFirebase('loveJar', ljData);
          ljInput.value = '';
          renderLoveJar();
        });
      }
      if(ljRandomBtn){
        ljRandomBtn.addEventListener('click', randomLoveNote);
      }
      if(ljList){
        renderLoveJar();
        listenFromFirebase('loveJar', setLoveJarData);
      }

      // ---- Quiz do casal ----
      const quizContainer = document.getElementById('quizContainer');
      const quizResult = document.getElementById('quizResult');
      const quizData = [
        {
          q: 'Quando a gente mais sente falta um do outro?',
          options: ['De manh√£', 'No meio do dia', '√Ä noite', 'Nunca sentimos falta'],
          correct: 2
        },
        {
          q: 'Qual √© o melhor programa pra n√≥s dois?',
          options: ['Ver filme abra√ßados', 'Sair pra comer', 'Viajar juntos', 'Qualquer coisa, se for contigo'],
          correct: 3
        },
        {
          q: 'Se o nosso amor fosse um emoji, qual seria?',
          options: ['üíî', 'üôÇ', 'üî•', 'üíñ'],
          correct: 3
        }
      ];
      let quizAnswers = {};

      function updateQuizResult(){
        if(!quizResult) return;
        const total = quizData.length;
        let correct = 0;
        quizData.forEach(function(item, idx){
          if(quizAnswers[idx] === item.correct) correct++;
        });
        if(Object.keys(quizAnswers).length === 0){
          quizResult.textContent = '';
          return;
        }
        if(correct === total){
          quizResult.textContent = 'Voc√™s s√£o 100% almas g√™meas, t√° decidido. üíñ';
        }else{
          quizResult.textContent = correct + ' de ' + total + ' respostas combinando. O importante √© rir juntos!';
        }
      }
      function renderQuiz(){
        if(!quizContainer) return;
        quizContainer.innerHTML = '';
        quizData.forEach(function(item, qi){
          const wrap = document.createElement('div');
          wrap.className = 'quiz-question';
          const q = document.createElement('div');
          q.textContent = item.q;
          wrap.appendChild(q);
          const optsWrap = document.createElement('div');
          optsWrap.className = 'quiz-options';
          item.options.forEach(function(opt, oi){
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'quiz-option-btn';
            btn.textContent = opt;
            btn.addEventListener('click', function(){
              quizAnswers[qi] = oi;
              Array.prototype.forEach.call(optsWrap.children, function(ch){
                ch.classList.remove('selected-correct', 'selected-wrong');
              });
              if(oi === item.correct){
                btn.classList.add('selected-correct');
              }else{
                btn.classList.add('selected-wrong');
              }
              updateQuizResult();
            });
            optsWrap.appendChild(btn);
          });
          wrap.appendChild(optsWrap);
          quizContainer.appendChild(wrap);
        });
      }
      if(quizContainer){
        renderQuiz();
      }

      // ---- V√≠deos ----
      const vdTitle = document.getElementById('videoTitle');
      const vdUrl = document.getElementById('videoUrl');
      const vdBtn = document.getElementById('videoAddBtn');
      const vdList = document.getElementById('videosList');
      let vdData = loadLS('videos', []);

      function setVideosData(arr){
        vdData = Array.isArray(arr) ? arr : [];
        saveLS('videos', vdData);
        renderVideos();
      }
      function renderVideos(){
        if(!vdList) return;
        vdList.innerHTML = '';
        vdData.forEach(function(item){
          const li = document.createElement('li');
          const title = document.createElement('div');
          title.textContent = item.title || 'V√≠deo';
          const a = document.createElement('a');
          a.href = item.url;
          a.target = '_blank';
          a.rel = 'noopener';
          a.textContent = item.url;
          li.appendChild(title);
          li.appendChild(a);
          vdList.appendChild(li);
        });
      }
      if(vdBtn && vdList){
        vdBtn.addEventListener('click', function(){
          const t = (vdTitle.value || '').trim();
          const u = (vdUrl.value || '').trim();
          if(!u) return;
          vdData.push({id:uid(), title:t, url:u});
          saveLS('videos', vdData);
          syncToFirebase('videos', vdData);
          vdTitle.value = '';
          vdUrl.value = '';
          renderVideos();
        });
        renderVideos();
        listenFromFirebase('videos', setVideosData);
      }

      // ---- Calend√°rio ----
      const evDate = document.getElementById('eventDate');
      const evTime = document.getElementById('eventTime');
      const evTitle = document.getElementById('eventTitle');
      const evBtn = document.getElementById('eventAddBtn');
      const evList = document.getElementById('eventsList');
      let evData = loadLS('events', []);

      function setEventsData(arr){
        evData = Array.isArray(arr) ? arr : [];
        saveLS('events', evData);
        renderEvents();
      }
      function renderEvents(){
        if(!evList) return;
        evList.innerHTML = '';
        const sorted = [].concat(evData).sort(function(a,b){
          const da = (a.date || '') + ' ' + (a.time || '');
          const db = (b.date || '') + ' ' + (b.time || '');
          return da.localeCompare(db);
        });
        sorted.forEach(function(item){
          const li = document.createElement('li');
          const title = document.createElement('div');
          const dt = (item.date || '') + (item.time ? ' √†s ' + item.time : '');
          title.textContent = item.title || 'Evento';
          const meta = document.createElement('div');
          meta.className = 'extra-meta';
          meta.textContent = dt;
          li.appendChild(title);
          if(dt.trim()){
            li.appendChild(meta);
          }
          evList.appendChild(li);
        });
      }
      if(evBtn && evList){
        evBtn.addEventListener('click', function(){
          const d = evDate.value || '';
          const t = evTime.value || '';
          const title = (evTitle.value || '').trim();
          if(!d && !title) return;
          evData.push({id:uid(), date:d, time:t, title:title});
          saveLS('events', evData);
          syncToFirebase('events', evData);
          evTitle.value = '';
          renderEvents();
        });
        renderEvents();
        listenFromFirebase('events', setEventsData);
      }

      // ---- Inspira√ß√µes ----
      const idInput = document.getElementById('ideaText');
      const idBtn = document.getElementById('ideaAddBtn');
      const idList = document.getElementById('ideasList');
      let idData = loadLS('ideas', []);

      function setIdeasData(arr){
        idData = Array.isArray(arr) ? arr : [];
        saveLS('ideas', idData);
        renderIdeas();
      }
      function renderIdeas(){
        if(!idList) return;
        idList.innerHTML = '';
        idData.forEach(function(item){
          const li = document.createElement('li');
          li.textContent = item.text;
          idList.appendChild(li);
        });
      }
      if(idBtn && idList){
        idBtn.addEventListener('click', function(){
          const txt = (idInput.value || '').trim();
          if(!txt) return;
          idData.push({id:uid(), text:txt});
          saveLS('ideas', idData);
          syncToFirebase('ideas', idData);
          idInput.value = '';
          renderIdeas();
        });
        renderIdeas();
        listenFromFirebase('ideas', setIdeasData);
      }

      // ---- Hist√≥rico de humor (gr√°fico) ----
      const moodCanvas = document.getElementById('moodChart');
      const moodStatus = document.getElementById('moodChartStatus');
      let moodData = loadLS('moodHistory', []);

      function setMoodData(arr){
        moodData = Array.isArray(arr) ? arr : [];
        saveLS('moodHistory', moodData);
        drawMoodChart();
      }
      function moodLevelValue(level){
        switch(level){
          case 'perfect': return 5;
          case 'good': return 4;
          case 'chill': return 3;
          case 'ice': return 2;
          case 'jail': return 1;
          default: return 3;
        }
      }
      function drawMoodChart(){
        if(!moodCanvas){
          return;
        }
        const ctx = moodCanvas.getContext('2d');
        const w = moodCanvas.width;
        const h = moodCanvas.height;
        ctx.clearRect(0,0,w,h);
        if(!moodData.length){
          if(moodStatus){
            moodStatus.textContent = 'Ainda n√£o h√° votos suficientes pra mostrar o gr√°fico. Use o painel "N√≠vel de satisfa√ß√£o com o moz√£o".';
          }
          return;
        }
        if(moodStatus){
          moodStatus.textContent = 'Mostrando at√© ' + moodData.length + ' votos recentes.';
        }
        const minV = 1;
        const maxV = 5;
        const margin = 20;
        const innerW = w - margin*2;
        const innerH = h - margin*2;
        const stepX = innerW / Math.max(1, moodData.length-1);

        ctx.lineWidth = 1;
        ctx.strokeStyle = '#cccccc';
        ctx.beginPath();
        ctx.moveTo(margin, margin);
        ctx.lineTo(margin, h - margin);
        ctx.lineTo(w - margin, h - margin);
        ctx.stroke();

        ctx.strokeStyle = '#ff4da6';
        ctx.lineWidth = 2;
        ctx.beginPath();
        moodData.forEach(function(item, idx){
          const x = margin + stepX*idx;
          const norm = (item.v - minV) / (maxV - minV || 1);
          const y = (h - margin) - norm * innerH;
          if(idx === 0) ctx.moveTo(x,y);
          else ctx.lineTo(x,y);
        });
        ctx.stroke();

        ctx.fillStyle = '#ff4da6';
        moodData.forEach(function(item, idx){
          const x = margin + stepX*idx;
          const norm = (item.v - minV) / (maxV - minV || 1);
          const y = (h - margin) - norm * innerH;
          ctx.beginPath();
          ctx.arc(x,y,3,0,Math.PI*2);
          ctx.fill();
        });
      }
      function registerMood(level){
        const who = localStorage.getItem('satCurrentUser') || 'desconhecido';
        const now = new Date();
        moodData.push({
          t: now.toISOString(),
          level: level,
          who: who,
          v: moodLevelValue(level)
        });
        if(moodData.length > 50){
          moodData = moodData.slice(moodData.length - 50);
        }
        saveLS('moodHistory', moodData);
        syncToFirebase('moodHistory', moodData);
        drawMoodChart();
      }
      if(moodCanvas){
        drawMoodChart();
        listenFromFirebase('moodHistory', setMoodData);
        const satRows = document.querySelectorAll('.sat-row');
        satRows.forEach(function(row){
          row.addEventListener('click', function(){
            const levelKey = row.dataset.level;
            if(levelKey){
              registerMood(levelKey);
            }
          });
        });
      }

      // ---- Notifica√ß√µes ----
      const notifRequestBtn = document.getElementById('notifRequestBtn');
      const notifTestBtn = document.getElementById('notifTestBtn');
      const notifStatus = document.getElementById('notifStatus');

      function updateNotifStatus(msg){
        if(notifStatus){
          notifStatus.textContent = msg;
        }
      }
      if('Notification' in window){
        updateNotifStatus('As notifica√ß√µes est√£o dispon√≠veis neste navegador.');
      }else if(notifStatus){
        updateNotifStatus('Esse navegador n√£o suporta notifica√ß√µes, mas o resto do site funciona normal üôÇ.');
      }

      if(notifRequestBtn){
        notifRequestBtn.addEventListener('click', function(){
          if(!('Notification' in window)){
            updateNotifStatus('Notifica√ß√µes n√£o suportadas aqui.');
            return;
          }
          Notification.requestPermission().then(function(permission){
            if(permission === 'granted'){
              updateNotifStatus('Notifica√ß√µes ativadas! Voc√™ pode receber lembretes fofos.');
            }else if(permission === 'denied'){
              updateNotifStatus('Notifica√ß√µes bloqueadas. Se quiser, voc√™ pode reativar nas configura√ß√µes do navegador.');
            }else{
              updateNotifStatus('Permiss√£o de notifica√ß√£o pendente.');
            }
          }).catch(function(){
            updateNotifStatus('N√£o foi poss√≠vel pedir permiss√£o de notifica√ß√£o.');
          });
        });
      }

      if(notifTestBtn){
        notifTestBtn.addEventListener('click', function(){
          if(!('Notification' in window)){
            updateNotifStatus('Notifica√ß√µes n√£o suportadas aqui.');
            return;
          }
          if(Notification.permission !== 'granted'){
            updateNotifStatus('Ative as notifica√ß√µes primeiro para testar.');
            return;
          }
          try{
            new Notification('Lembrete fofinho üíï', {
              body: 'Passando s√≥ pra lembrar que voc√™s se amam muito.'
            });
            updateNotifStatus('Notifica√ß√£o de teste enviada.');
          }catch(e){
            updateNotifStatus('N√£o deu pra enviar a notifica√ß√£o de teste.');
          }
        });
      }
    })();

</script>
<script>
  (function(){
    const hub = {
      menu: document.getElementById('hubMenu'),
      toggle: document.getElementById('hubToggle'),
      sections: Array.from(document.querySelectorAll('.hub-section')),
      buttons: Array.from(document.querySelectorAll('.hub-menu button'))
    };
    const prefix = 'megaHub_';
    const hasFirebase = typeof db !== 'undefined' && db;

    const getLS = (k, def) => {
      try{ const v = localStorage.getItem(prefix + k); return v ? JSON.parse(v) : def; }catch(e){ return def; }
    };
    const setLS = (k, v) => { try{ localStorage.setItem(prefix + k, JSON.stringify(v)); }catch(e){} };
    const sync = (k, data) => { if(!hasFirebase) return; try{ db.ref('hub/' + coupleId + '/' + k).set(data); }catch(e){} };
    const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2);

    // Abas principais (menu a partir do painel de satisfa√ß√£o)
    const tabButtons = Array.from(document.querySelectorAll('.tab-btn'));
    const tabPanels = Array.from(document.querySelectorAll('[data-tab-section]'));
    function setMainTab(tab){
      const exists = tabButtons.some(btn => btn.dataset.tab === tab);
      const target = exists ? tab : 'tudo';
      tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === target));
      tabPanels.forEach(panel => {
        const tags = (panel.dataset.tabSection || '').split(/\s+/).filter(Boolean);
        const show = target === 'tudo' || tags.includes(target);
        panel.classList.toggle('tab-hidden', !show);
      });
      setLS('mainTab', target);
    }
    if(tabButtons.length && tabPanels.length){
      const savedTab = getLS('mainTab', 'tudo');
      setMainTab(savedTab);
      tabButtons.forEach(btn => btn.addEventListener('click', ()=> setMainTab(btn.dataset.tab)));
    }
    const retroPlayBtn = document.getElementById('retroPlayBtn');
    if(retroPlayBtn){
      retroPlayBtn.addEventListener('click', ()=> setMainTab('retrospectiva'));
    }

    // Navega√ß√£o
    function setSection(id){
      hub.sections.forEach(sec => sec.classList.toggle('active', sec.id === id));
      hub.buttons.forEach(btn => btn.classList.toggle('active', btn.dataset.target === id));
    }
    if(hub.toggle){
      hub.toggle.addEventListener('click', ()=> hub.menu.classList.toggle('show'));
    }
    hub.buttons.forEach(btn => btn.addEventListener('click', ()=>{ setSection(btn.dataset.target); hub.menu.classList.remove('show'); }));

    // Login leve
    const defaultPins = {pablo:'1111', ana:'2222'};
    const pins = Object.assign({}, defaultPins, getLS('pins', {}));
    const currentUser = getLS('currentUser', 'pablo');
    const hubUser = document.getElementById('hubUser');
    const hubPin = document.getElementById('hubPin');
    const hubLoginBtn = document.getElementById('hubLoginBtn');
    const hubPinSaveBtn = document.getElementById('hubPinSaveBtn');
    const hubLoginStatus = document.getElementById('hubLoginStatus');
    if(hubUser){ hubUser.value = currentUser; }
    function setStatus(msg){ if(hubLoginStatus) hubLoginStatus.textContent = msg; }
    if(hubLoginBtn){
      hubLoginBtn.addEventListener('click', ()=>{
        const u = hubUser.value || 'pablo';
        const pin = hubPin.value || '';
        if(pin === pins[u]){
          setLS('currentUser', u);
          setStatus('Oi, ' + u + '! Login leve feito.');
        }else{
          setStatus('PIN incorreto para ' + u + '.');
        }
      });
    }
    if(hubPinSaveBtn){
      hubPinSaveBtn.addEventListener('click', ()=>{
        const u = hubUser.value || 'pablo';
        const pin = hubPin.value || '';
        if(pin.length === 4){
          pins[u] = pin;
          setLS('pins', pins);
          setStatus('Novo PIN salvo para ' + u + '.');
          sync('pins', pins);
        }else{
          setStatus('Use 4 d√≠gitos.');
        }
      });
    }

    // Bilhetes
    let messages = getLS('messages', []);
    const msgAuthor = document.getElementById('msgAuthor');
    const msgType = document.getElementById('msgType');
    const msgText = document.getElementById('msgText');
    const msgFilter = document.getElementById('msgFilter');
    const msgList = document.getElementById('msgList');
    const msgUnread = document.getElementById('msgUnread');
    let lastRead = getLS('lastRead', Date.now());
    function renderMessages(){
      if(!msgList) return;
      const filter = msgFilter.value;
      msgList.innerHTML = '';
      const unreadCount = messages.filter(m => m.ts > lastRead).length;
      if(msgUnread){ msgUnread.textContent = unreadCount + ' novos'; }
      messages.filter(m => filter === 'todos' || m.type === filter).sort((a,b)=>b.ts-a.ts).forEach(m=>{
        const li = document.createElement('li');
        li.innerHTML = `<div><strong>${m.author}</strong> ‚Ä¢ <span class="tag">${m.type}</span></div><div>${m.text}</div><small>${new Date(m.ts).toLocaleString()}</small>`;
        msgList.appendChild(li);
      });
      lastRead = Date.now();
      setLS('lastRead', lastRead);
    }
    if(msgFilter) msgFilter.addEventListener('change', renderMessages);
    const sendMsgBtn = document.getElementById('sendMsgBtn');
    if(sendMsgBtn){
      sendMsgBtn.addEventListener('click', ()=>{
        const text = msgText.value.trim();
        if(!text) return;
        const data = {id:uid(), author:msgAuthor.value, type:msgType.value, text, ts:Date.now()};
        messages.push(data);
        setLS('messages', messages);
        sync('messages', messages);
        msgText.value = '';
        renderMessages();
      });
    }
    if(hasFirebase){ db.ref('hub/' + coupleId + '/messages').on('value', snap=>{ if(snap.val()) { messages = Object.values(snap.val()); setLS('messages', messages); renderMessages(); } }); }
    renderMessages();

    // Time-capsule
    let capsules = getLS('capsules', []);
    const capsList = document.getElementById('capsList');
    function renderCaps(){
      if(!capsList) return;
      capsList.innerHTML='';
      capsules.sort((a,b)=>a.unlockAt-b.unlockAt).forEach(c=>{
        const unlocked = Date.now() >= c.unlockAt;
        const li = document.createElement('li');
        li.className = unlocked ? '' : 'locked';
        li.innerHTML = `<div><strong>${c.title}</strong> <span class="badge">${new Date(c.unlockAt).toLocaleDateString()}</span></div><div>${unlocked ? c.text : 'Abre em ' + Math.ceil((c.unlockAt-Date.now())/86400000) + ' dias'}</div><small>${c.from} ‚ûú ${c.to}</small>`;
        capsList.appendChild(li);
      });
    }
    const capsSaveBtn = document.getElementById('capsSaveBtn');
    if(capsSaveBtn){
      capsSaveBtn.addEventListener('click', ()=>{
        const title = document.getElementById('capsTitle').value.trim();
        const from = document.getElementById('capsFrom').value.trim();
        const to = document.getElementById('capsTo').value.trim();
        const text = document.getElementById('capsText').value.trim();
        const date = document.getElementById('capsDate').value;
        if(!title || !date) return;
        const unlockAt = new Date(date + 'T00:00:00').getTime();
        capsules.push({id:uid(), title, from, to, text, unlockAt});
        setLS('capsules', capsules);
        sync('capsules', capsules);
        renderCaps();
      });
    }
    if(hasFirebase){ db.ref('hub/' + coupleId + '/capsules').on('value', snap=>{ if(snap.val()){ capsules = Object.values(snap.val()); setLS('capsules', capsules); renderCaps(); } }); }
    renderCaps();

    // Roleta
    let wheelData = getLS('wheel', []);
    const wheelList = document.getElementById('wheelList');
    const wheelResult = document.getElementById('wheelResult');
    function renderWheel(){
      if(!wheelList) return;
      wheelList.innerHTML='';
      wheelData.forEach(item=>{
        const li=document.createElement('li');
        li.innerHTML = `<strong>${item.text}</strong> <span class="tag">${item.mode}</span>`;
        wheelList.appendChild(li);
      });
    }
    const wheelAddBtn = document.getElementById('wheelAddBtn');
    if(wheelAddBtn){
      wheelAddBtn.addEventListener('click', ()=>{
        const text = document.getElementById('wheelItem').value.trim();
        const mode = document.getElementById('wheelMode').value;
        if(!text) return;
        wheelData.push({id:uid(), text, mode});
        setLS('wheel', wheelData);
        sync('wheel', wheelData);
        document.getElementById('wheelItem').value='';
        renderWheel();
      });
    }
    const wheelSpinBtn = document.getElementById('wheelSpinBtn');
    if(wheelSpinBtn){
      wheelSpinBtn.addEventListener('click', ()=>{
        if(!wheelData.length){ if(wheelResult) wheelResult.textContent='Cadastre algo primeiro'; return; }
        const choice = wheelData[Math.floor(Math.random()*wheelData.length)];
        if(wheelResult){ wheelResult.textContent = choice.text + ' (' + choice.mode + ')'; }
      });
    }
    const wheelClearBtn = document.getElementById('wheelClearBtn');
    if(wheelClearBtn){ wheelClearBtn.addEventListener('click', ()=>{ wheelData=[]; setLS('wheel', wheelData); sync('wheel', wheelData); renderWheel(); }); }
    if(hasFirebase){ db.ref('hub/' + coupleId + '/wheel').on('value', snap=>{ if(snap.val()){ wheelData=Object.values(snap.val()); setLS('wheel', wheelData); renderWheel(); } }); }
    renderWheel();

    // Cupons
    let coupons = getLS('coupons', []);
    const couponList = document.getElementById('couponList');
    const couponStats = document.getElementById('couponStats');
    function renderCoupons(){
      if(!couponList) return;
      couponList.innerHTML='';
      coupons.forEach(c=>{
        const li=document.createElement('li');
        li.innerHTML = `<div><strong>${c.text}</strong></div><small>${c.used ? 'Usado em ' + new Date(c.usedAt).toLocaleDateString() : 'Dispon√≠vel'}</small>`;
        const btn=document.createElement('button');
        btn.className='btn btn-mini ' + (c.used ? 'btn-mini-danger' : 'btn-mini-primary');
        btn.textContent = c.used ? 'Reabrir' : 'Resgatar';
        btn.addEventListener('click', ()=>{
          c.used = !c.used;
          c.usedAt = c.used ? Date.now() : null;
          setLS('coupons', coupons);
          sync('coupons', coupons);
          renderCoupons();
        });
        li.appendChild(btn);
        couponList.appendChild(li);
      });
      const usados = coupons.filter(c=>c.used).length;
      if(couponStats) couponStats.textContent = `${coupons.length} cupons ‚Ä¢ ${usados} usados`;
    }
    const couponAddBtn = document.getElementById('couponAddBtn');
    if(couponAddBtn){
      couponAddBtn.addEventListener('click', ()=>{
        const text = document.getElementById('couponText').value.trim();
        if(!text) return;
        coupons.push({id:uid(), text, used:false, usedAt:null});
        setLS('coupons', coupons);
        sync('coupons', coupons);
        document.getElementById('couponText').value='';
        renderCoupons();
      });
    }
    if(hasFirebase){ db.ref('hub/' + coupleId + '/coupons').on('value', snap=>{ if(snap.val()){ coupons=Object.values(snap.val()); setLS('coupons', coupons); renderCoupons(); } }); }
    renderCoupons();

    // Viagem e metas
    let goal = getLS('goal', {meta:0, contribs:[]});
    const goalProgress = document.getElementById('goalProgress');
    const goalStatus = document.getElementById('goalStatus');
    const goalList = document.getElementById('goalList');
    function renderGoal(){
      const total = goal.contribs.reduce((s,c)=>s+Number(c.amount||0),0);
      const pct = goal.meta ? Math.min(100, Math.round((total/goal.meta)*100)) : 0;
      if(goalProgress) goalProgress.style.width = pct + '%';
      if(goalStatus) goalStatus.textContent = `Meta: R$${goal.meta || 0} | J√° temos R$${total} (${pct}%)`;
      if(goalList){
        goalList.innerHTML='';
        goal.contribs.sort((a,b)=>b.ts-a.ts).forEach(c=>{
          const li=document.createElement('li');
          li.innerHTML = `<strong>${c.who}</strong> contribuiu R$${c.amount} em ${new Date(c.ts).toLocaleDateString()}`;
          goalList.appendChild(li);
        });
      }
    }
    const goalSaveBtn = document.getElementById('goalSaveBtn');
    if(goalSaveBtn){ goalSaveBtn.addEventListener('click', ()=>{ goal.meta = Number(document.getElementById('goalValue').value)||0; setLS('goal', goal); sync('goal', goal); renderGoal(); }); }
    const goalAddBtn = document.getElementById('goalAddBtn');
    if(goalAddBtn){ goalAddBtn.addEventListener('click', ()=>{ const who=document.getElementById('goalWho').value.trim(); const amount=Number(document.getElementById('goalAmount').value)||0; if(!who||!amount) return; goal.contribs.push({id:uid(), who, amount, ts:Date.now()}); setLS('goal', goal); sync('goal', goal); renderGoal(); }); }
    if(hasFirebase){ db.ref('hub/' + coupleId + '/goal').on('value', snap=>{ if(snap.val()){ goal=snap.val(); setLS('goal', goal); renderGoal(); } }); }
    renderGoal();

    // Roteiro
    let routes = getLS('routes', []);
    const routeList = document.getElementById('routeList');
    function renderRoutes(){ if(!routeList) return; routeList.innerHTML=''; routes.forEach(r=>{ const li=document.createElement('li'); li.innerHTML = `<strong>${r.place}</strong> ‚Äî ${r.budget}`; routeList.appendChild(li); }); }
    const routeAddBtn = document.getElementById('routeAddBtn');
    if(routeAddBtn){ routeAddBtn.addEventListener('click', ()=>{ const place=document.getElementById('routePlace').value.trim(); const budget=document.getElementById('routeBudget').value.trim(); if(!place) return; routes.push({id:uid(), place, budget}); setLS('routes', routes); sync('routes', routes); renderRoutes(); }); }
    if(hasFirebase){ db.ref('hub/' + coupleId + '/routes').on('value', snap=>{ if(snap.val()){ routes=Object.values(snap.val()); setLS('routes', routes); renderRoutes(); } }); }
    renderRoutes();

    // Cap√≠tulos
    let chapters = getLS('chapters', []);
    const chapterList = document.getElementById('chapterList');
    function renderChapters(){ if(!chapterList) return; chapterList.innerHTML=''; chapters.forEach(c=>{ const li=document.createElement('li'); li.innerHTML = `<div><strong>${c.title}</strong> <span class="tag">${c.cat}</span></div><div>${c.text}</div>`; chapterList.appendChild(li); }); }
    const chapterAddBtn = document.getElementById('chapterAddBtn');
    if(chapterAddBtn){ chapterAddBtn.addEventListener('click', ()=>{ const title=document.getElementById('chapterTitle').value.trim(); const cat=document.getElementById('chapterCat').value.trim(); const text=document.getElementById('chapterText').value.trim(); if(!title||!text) return; chapters.push({id:uid(), title, cat, text}); setLS('chapters', chapters); sync('chapters', chapters); renderChapters(); }); }
    if(hasFirebase){ db.ref('hub/' + coupleId + '/chapters').on('value', snap=>{ if(snap.val()){ chapters=Object.values(snap.val()); setLS('chapters', chapters); renderChapters(); } }); }
    renderChapters();

    // Di√°rio
    let diary = getLS('diary', []);
    const diaryList = document.getElementById('diaryList');
    function renderDiary(){ if(!diaryList) return; diaryList.innerHTML=''; diary.sort((a,b)=>b.date.localeCompare(a.date)).forEach(d=>{ const li=document.createElement('li'); li.innerHTML = `<strong>${d.date}</strong><div>${d.text}</div>`; diaryList.appendChild(li); }); }
    const diarySaveBtn = document.getElementById('diarySaveBtn');
    if(diarySaveBtn){ diarySaveBtn.addEventListener('click', ()=>{ const date=document.getElementById('diaryDate').value; const text=document.getElementById('diaryText').value.trim(); if(!date||!text) return; diary.push({id:uid(), date, text}); setLS('diary', diary); sync('diary', diary); renderDiary(); }); }
    if(hasFirebase){ db.ref('hub/' + coupleId + '/diary').on('value', snap=>{ if(snap.val()){ diary=Object.values(snap.val()); setLS('diary', diary); renderDiary(); } }); }
    renderDiary();

    // Achievements
    const achList = document.getElementById('achList');
    function renderAchievements(){
      if(!achList) return;
      const stats = {
        msgs: messages.length,
        caps: capsules.length,
        couponsUsed: coupons.filter(c=>c.used).length,
        dreams: (JSON.parse(localStorage.getItem('acLove_bucket')||'[]')).length,
        mood: (JSON.parse(localStorage.getItem('acLove_moodHistory')||'[]')).length
      };
      const achievements = [
        {title:'10 bilhetes no pote', ok: stats.msgs >=10},
        {title:'Primeiro segredo aberto', ok: capsules.some(c=>Date.now()>=c.unlockAt)},
        {title:'5 cupons resgatados', ok: stats.couponsUsed>=5},
        {title:'Mapa/roteiro criado', ok: routes.length>0},
        {title:'Humor registrado 15x', ok: stats.mood>=15}
      ];
      achList.innerHTML='';
      achievements.forEach(a=>{
        const li=document.createElement('li');
        li.innerHTML = `${a.ok ? 'üèÖ' : 'üîí'} ${a.title}`;
        achList.appendChild(li);
      });
    }
    renderAchievements();

    // Resumo mensal
    const hubResumoBtn = document.getElementById('hubResumoBtn');
    const hubResumoMes = document.getElementById('hubResumoMes');
    const hubResumoDados = document.getElementById('hubResumoDados');
    if(hubResumoBtn){
      hubResumoBtn.addEventListener('click', ()=>{
        const month = hubResumoMes.value;
        if(!month) return;
        const [y,m] = month.split('-');
        const start = new Date(Number(y), Number(m)-1,1).getTime();
        const end = new Date(Number(y), Number(m),1).getTime();
        const msgsMes = messages.filter(m=>m.ts>=start && m.ts<end).length;
        const capsMes = capsules.filter(c=>c.unlockAt>=start && c.unlockAt<end).length;
        const contribMes = goal.contribs.filter(c=>c.ts>=start && c.ts<end).reduce((s,c)=>s+Number(c.amount||0),0);
        const diarioMes = diary.filter(d=>{ const t=new Date(d.date).getTime(); return t>=start && t<end; }).length;
        const humor = (JSON.parse(localStorage.getItem('acLove_moodHistory')||'[]')).filter(h=>{ const t=new Date(h.t||h.ts||h.date||h).getTime(); return t>=start && t<end; });
        const humorMedio = humor.length ? Math.round(humor.reduce((s,h)=>s+(h.v||h.level||0),0)/humor.length) : 0;
        hubResumoDados.textContent = `Bilhetes: ${msgsMes}, Cartas futuras: ${capsMes}, Contribui√ß√µes: R$${contribMes}, Di√°rio: ${diarioMes}, Humor m√©dio: ${humorMedio}`;
      });
    }

    // Stats dashboard
    const statsCards = document.getElementById('statsCards');
    const statsCanvas = document.getElementById('statsCanvas');
    function renderStats(){
      if(statsCards){
        statsCards.innerHTML='';
        const cards = [
          {label:'Bilhetes', value: messages.length},
          {label:'Cupons usados', value: coupons.filter(c=>c.used).length},
          {label:'Metas alcan√ßadas', value: goal.meta>0 && goal.contribs.reduce((s,c)=>s+Number(c.amount||0),0)>=goal.meta ? 1 : 0},
          {label:'Capsulas', value: capsules.length}
        ];
        cards.forEach(c=>{
          const div=document.createElement('div');
          div.className='hub-box';
          div.innerHTML = `<div class="pill">${c.label}</div><h2 style="margin:6px 0;">${c.value}</h2>`;
          statsCards.appendChild(div);
        });
      }
      if(statsCanvas){
        const ctx = statsCanvas.getContext('2d');
        ctx.clearRect(0,0,statsCanvas.width, statsCanvas.height);
        const data = goal.contribs.slice(-8);
        const max = Math.max(1, ...data.map(d=>Number(d.amount||0)));
        const step = statsCanvas.width / (data.length||1);
        ctx.strokeStyle='#ff4da6';
        ctx.beginPath();
        data.forEach((d,i)=>{
          const x = i*step + 10;
          const y = statsCanvas.height - (Number(d.amount||0)/max)*(statsCanvas.height-20) - 10;
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
          ctx.fillText(d.who||'', x, statsCanvas.height-4);
        });
        ctx.stroke();
      }
    }
    renderStats();

    // PWA / service worker
    const pwaBtn = document.getElementById('pwaRegisterBtn');
    const pwaStatus = document.getElementById('pwaStatus');
    if(pwaBtn){
      pwaBtn.addEventListener('click', ()=>{
        if('serviceWorker' in navigator){
          navigator.serviceWorker.register('sw.js').then(()=>{
            if(pwaStatus) pwaStatus.textContent = 'Modo offline ativado!';
          }).catch(()=>{ if(pwaStatus) pwaStatus.textContent = 'N√£o deu pra registrar agora.'; });
        }else{
          if(pwaStatus) pwaStatus.textContent = 'Seu navegador n√£o aceita service worker.';
        }
      });
    }
  })();

// =====================
// RETROSPECTIVA (HORAS JUNTOS)
// =====================
(function(){
  // Datas base (ano, m√™s-0-a-11, dia)
  const togetherSince = new Date(2023, 6, 6);   // 06/07/2023
  const datingSince   = new Date(2023, 8, 23);  // 23/09/2023

  const now = new Date();
  const yearStart = new Date(now.getFullYear(), 0, 1);

  function diffInfo(start){
    const current = new Date();
    const diffMs  = current.getTime() - start.getTime();
    const hours   = Math.floor(diffMs / (1000 * 60 * 60));
    const days    = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    return { hours, days };
  }

  function renderWrapped(){
    const elHoursTogether = document.getElementById('wrHoursTogether');
    const elHoursYear     = document.getElementById('wrHoursYear');
    const elDaysTogether  = document.getElementById('wrDaysTogether');
    const elDaysDating    = document.getElementById('wrDaysDating');

    if(!elHoursTogether) return;

    const together = diffInfo(togetherSince);
    const dating   = diffInfo(datingSince);
    const yearOnly = diffInfo(yearStart);

    elHoursTogether.textContent = together.hours.toLocaleString('pt-BR');
    elDaysTogether.textContent  = together.days.toLocaleString('pt-BR');
    if(elDaysDating){
      elDaysDating.textContent = dating.days.toLocaleString('pt-BR');
    }
    if(elHoursYear){
      elHoursYear.textContent = yearOnly.hours.toLocaleString('pt-BR') + ' h';
    }
  }

  renderWrapped();
  setInterval(renderWrapped, 1000 * 60 * 10);
})();
</script>
</body>
</html>
